{% extends "base.html" %} {% block title %}매매일지 - 키움 자동매매{% endblock
%} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-book me-2"></i>매매일지</h2>
      <div>
        <button
          class="btn btn-outline-primary me-2"
          onclick="refreshTradingDiary()"
        >
          <i class="fas fa-sync-alt"></i> 새로고침
        </button>
        <button class="btn btn-primary" onclick="exportTradingDiary()">
          <i class="fas fa-download"></i> 내보내기
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 매매 통계 카드 -->
<div class="row mb-4 trading-summary-cards">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">총 매매 건수</h6>
            <h4 class="mb-0" id="total-trades">-</h4>
          </div>
          <div class="align-self-center">
            <i class="fas fa-exchange-alt fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-success text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">총 수익금액</h6>
            <h4 class="mb-0" id="total-profit">-</h4>
          </div>
          <div class="align-self-center">
            <i class="fas fa-chart-line fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-info text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">승률</h6>
            <h4 class="mb-0" id="win-rate">-</h4>
          </div>
          <div class="align-self-center">
            <i class="fas fa-percentage fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">평균 수익률</h6>
            <h4 class="mb-0" id="avg-return">-</h4>
          </div>
          <div class="align-self-center">
            <i class="fas fa-chart-bar fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 필터 및 검색 -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="diary-date-from" class="form-label">시작일</label>
            <input
              type="date"
              class="form-control"
              id="diary-date-from"
              onchange="filterTradingDiary()"
            />
          </div>
          <div class="col-md-3">
            <label for="diary-date-to" class="form-label">종료일</label>
            <input
              type="date"
              class="form-control"
              id="diary-date-to"
              onchange="filterTradingDiary()"
            />
          </div>
          <div class="col-md-3">
            <label for="profit-filter" class="form-label">수익구분</label>
            <select
              class="form-select"
              id="profit-filter"
              onchange="filterTradingDiary()"
            >
              <option value="">전체</option>
              <option value="profit">수익</option>
              <option value="loss">손실</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="diary-stock-search" class="form-label">종목 검색</label>
            <input
              type="text"
              class="form-control"
              id="diary-stock-search"
              placeholder="종목명 또는 코드"
              onkeyup="filterTradingDiary()"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 탭 네비게이션 -->
<ul class="nav nav-tabs mb-4" id="diaryTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button
      class="nav-link active"
      id="daily-tab"
      data-bs-toggle="tab"
      data-bs-target="#daily"
      type="button"
      role="tab"
    >
      <i class="fas fa-calendar-day me-1"></i>일별 매매일지
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button
      class="nav-link"
      id="profit-chart-tab"
      data-bs-toggle="tab"
      data-bs-target="#profit-chart"
      type="button"
      role="tab"
    >
      <i class="fas fa-chart-column me-1"></i>일별 손익 그래프
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button
      class="nav-link"
      id="cum-profit-chart-tab"
      data-bs-toggle="tab"
      data-bs-target="#cum-profit-chart"
      type="button"
      role="tab"
    >
      <i class="fas fa-chart-line me-1"></i>누적 손익 그래프
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button
      class="nav-link"
      id="monthly-tab"
      data-bs-toggle="tab"
      data-bs-target="#monthly"
      type="button"
      role="tab"
    >
      <i class="fas fa-calendar-alt me-1"></i>월별 매매일지
    </button>
  </li>
</ul>

<!-- 탭 콘텐츠 -->
<div class="tab-content" id="diaryTabContent">
  <!-- 일별 매매일지 탭 -->
  <div class="tab-pane fade show active" id="daily" role="tabpanel">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">
          <i class="fas fa-calendar-day me-2"></i>일별 매매일지
        </h5>
        <div class="d-flex gap-2">
          <select
            class="form-select form-select-sm"
            id="sort-daily"
            onchange="sortDailyTrades()"
          >
            <option value="date">거래일</option>
            <option value="profit">수익금액</option>
            <option value="return">수익률</option>
            <option value="count">매매건수</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="daily-trades-table">
            <thead>
              <tr>
                <th>거래일</th>
                <th>매매건수</th>
                <th>매수금액</th>
                <th>매도금액</th>
                <th>수수료</th>
                <th>세금</th>
                <th>손익금액</th>
                <th>수익률</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="daily-trades-tbody">
              <tr>
                <td colspan="9" class="text-center text-muted">
                  데이터를 불러오는 중...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 일별 손익 그래프 탭 -->
  <div class="tab-pane fade" id="profit-chart" role="tabpanel">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-chart-column me-2"></i>일별 손익금액 그래프
        </h5>
        <small class="text-muted">일별 손익금액(profit_amount) 기준</small>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <div class="profit-chart-container">
              <canvas id="daily-profit-chart" height="260"></canvas>
            </div>
            <div class="form-text mt-2">
              수익(+)은 <span class="text-up fw-semibold">빨강</span>, 손실(-)은
              <span class="text-down fw-semibold">파랑</span>으로 표시됩니다.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 누적 손익 그래프 탭 -->
  <div class="tab-pane fade" id="cum-profit-chart" role="tabpanel">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-chart-line me-2"></i>누적 손익금액 그래프
        </h5>
        <small class="text-muted">일별 손익금액(profit_amount) 누적 합계</small>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <div class="profit-chart-container">
              <canvas id="daily-cum-profit-chart" height="260"></canvas>
            </div>
            <div class="form-text mt-2">
              날짜순으로 손익금액을 누적한 결과를 선형(Line) 그래프로 표시합니다.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 월별 매매일지 탭 -->
  <div class="tab-pane fade" id="monthly" role="tabpanel">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">
          <i class="fas fa-calendar-alt me-2"></i>월별 매매일지
        </h5>
        <div class="d-flex gap-2">
          <select
            class="form-select form-select-sm"
            id="sort-monthly"
            onchange="sortMonthlyTrades()"
          >
            <option value="month">월</option>
            <option value="profit">수익금액</option>
            <option value="return">수익률</option>
            <option value="count">매매건수</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="monthly-trades-table">
            <thead>
              <tr>
                <th>월</th>
                <th>매매건수</th>
                <th>매수금액</th>
                <th>매도금액</th>
                <th>수수료</th>
                <th>세금</th>
                <th>손익금액</th>
                <th>수익률</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="monthly-trades-tbody">
              <tr>
                <td colspan="9" class="text-center text-muted">
                  데이터를 불러오는 중...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- 일별 상세 모달 -->
<div class="modal fade" id="dailyDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-dark" id="dailyDetailTitle">일별 매매 상세</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="dailyDetailBody">
        <!-- 일별 상세 정보가 여기에 표시됩니다 -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          닫기
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<style>
  /* 매매일지 상단 카드 높이 통일 */
  .trading-summary-cards .card {
    height: 85px !important;
    display: flex;
    flex-direction: column;
  }

  .trading-summary-cards .card-body {
    flex: 1;
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
  }

  /* 동적 색상 클래스가 높이에 영향을 주지 않도록 */
  .trading-summary-cards .card-body h4 {
    margin-bottom: 0;
    line-height: 1.2;
    font-size: 1.4rem;
    font-weight: 600;
  }

  /* 아이콘을 오른쪽 끝으로 배치 */
  .trading-summary-cards .card-body .d-flex {
    width: 100%;
    justify-content: space-between;
  }

  .trading-summary-cards .card-body .align-self-center {
    align-self: center !important;
    margin-left: auto;
  }

  /* 손익 그래프 컨테이너 */
  .profit-chart-container {
    position: relative;
    width: 100%;
    min-height: 320px;
  }
</style>
<!-- Chart.js (매매일지 페이지에서만 사용) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // 매매일지 전용 JavaScript
  let dailyTradesData = [];
  let monthlyTradesData = [];
  let dailyProfitChart = null;
  let dailyCumProfitChart = null;
  let currentDailyDisplayedData = [];

  document.addEventListener("DOMContentLoaded", function () {
    // 서버 정보 즉시 업데이트
    updateServerInfoFromTemplate();

    // 기본 날짜 설정 (최근 30일)
    const today = new Date();
    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

    document.getElementById("diary-date-to").value = today
      .toISOString()
      .split("T")[0];
    document.getElementById("diary-date-from").value = monthAgo
      .toISOString()
      .split("T")[0];

    loadTradingDiary();

    // 5분마다 자동 새로고침 (API 호출 빈도 감소)
    setInterval(loadTradingDiary, 300000);

    // 탭 전환 시 차트 리사이즈 (hidden 상태에서 생성된 캔버스 대응)
    const profitTab = document.getElementById("profit-chart-tab");
    if (profitTab) {
      profitTab.addEventListener("shown.bs.tab", function () {
        if (dailyProfitChart) dailyProfitChart.resize();
      });
    }
    const cumProfitTab = document.getElementById("cum-profit-chart-tab");
    if (cumProfitTab) {
      cumProfitTab.addEventListener("shown.bs.tab", function () {
        if (dailyCumProfitChart) dailyCumProfitChart.resize();
      });
    }
  });

  function updateServerInfoFromTemplate() {
    // 템플릿에서 전달받은 서버 정보로 즉시 업데이트
    {% if server_info %}
    const serverNameElement = document.getElementById('server-name');
    const serverInfoElement = document.getElementById('server-info');

    if (serverNameElement && serverInfoElement) {
      serverNameElement.textContent = '{{ server_info.server_name }}';

      // 서버별 색상 적용
      if ('{{ server_info.server_type }}' === 'mock') {
        serverInfoElement.style.color = '#4CAF50';
      } else {
        serverInfoElement.style.color = '#F44336';
      }
    }
    {% endif %}
  }

  function loadTradingDiary() {
    // API 호출을 순차적으로 실행하여 429 오류 방지
    loadDailyTrades()
      .then(() => {
        setTimeout(() => loadMonthlyTrades(), 1000);
      });
  }

  function loadDailyTrades() {
    const startDate = document
      .getElementById("diary-date-from")
      .value.replace(/-/g, "");
    const endDate = document
      .getElementById("diary-date-to")
      .value.replace(/-/g, "");

    return fetch(
      `/api/account/trading/daily?start_date=${startDate}&end_date=${endDate}`
    )
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.data.daily_trades) {
          dailyTradesData = data.data.daily_trades;
          updateTradingSummary(data.data);
          currentDailyDisplayedData = dailyTradesData.slice();
          updateDailyTradesTable(currentDailyDisplayedData);
          renderDailyProfitChart(currentDailyDisplayedData);
          renderDailyCumProfitChart(currentDailyDisplayedData);
        } else if (data.authenticated === false) {
          isAuthenticated = false;
          updateAuthUI(false);
          showAlert("세션이 만료되었습니다. 다시 로그인해주세요.", "warning");
          return;
        } else {
          let message = '매매 내역이 없습니다.';
          if (data.message) {
            message = data.message;
          }
          currentDailyDisplayedData = [];
          renderDailyProfitChart(currentDailyDisplayedData);
          renderDailyCumProfitChart(currentDailyDisplayedData);
          document.getElementById("daily-trades-tbody").innerHTML =
            `<tr><td colspan="9" class="text-center text-muted">${message}</td></tr>`;
        }
      })
      .catch((error) => {
        console.error("일별 매매일지 조회 실패:", error);
        currentDailyDisplayedData = [];
        renderDailyProfitChart(currentDailyDisplayedData);
        renderDailyCumProfitChart(currentDailyDisplayedData);
        document.getElementById("daily-trades-tbody").innerHTML =
          '<tr><td colspan="9" class="text-center text-danger">데이터 조회 실패</td></tr>';
      });
  }

  function loadMonthlyTrades() {
    const startDate = document
      .getElementById("diary-date-from")
      .value.replace(/-/g, "");
    const endDate = document
      .getElementById("diary-date-to")
      .value.replace(/-/g, "");

    return fetch(
      `/api/account/trading/monthly?start_date=${startDate}&end_date=${endDate}`
    )
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.data.monthly_trades) {
          monthlyTradesData = data.data.monthly_trades;
          updateMonthlyTradesTable(monthlyTradesData);
        } else if (data.authenticated === false) {
          isAuthenticated = false;
          updateAuthUI(false);
          showAlert("세션이 만료되었습니다. 다시 로그인해주세요.", "warning");
          return;
        } else {
          let message = '월별 매매 내역이 없습니다.';
          if (data.message) {
            message = data.message;
          }
          document.getElementById("monthly-trades-tbody").innerHTML =
            `<tr><td colspan="9" class="text-center text-muted">${message}</td></tr>`;
        }
      })
      .catch((error) => {
        console.error("월별 매매일지 조회 실패:", error);
        document.getElementById("monthly-trades-tbody").innerHTML =
          '<tr><td colspan="9" class="text-center text-danger">데이터 조회 실패</td></tr>';
      });
  }


  function updateTradingSummary(data) {
    const trades = data.daily_trades || [];
    const totalTrades = trades.reduce(
      (sum, trade) => sum + parseInt(trade.trade_count || "0"),
      0
    );
    const totalProfit = trades.reduce(
      (sum, trade) => sum + parseFloat(trade.profit_amount || "0"),
      0
    );

    let totalReturn = 0;

    trades.forEach((trade) => {
      totalReturn += parseFloat(trade.return_rate || "0");
    });

    // 서버에서 계산된 승률 사용
    const winRate = data.summary ? data.summary.win_rate : "0.0";
    const avgReturn =
      trades.length > 0 ? (totalReturn / trades.length).toFixed(2) : "0.00";

    document.getElementById("total-trades").textContent = totalTrades + "건";
    document.getElementById("total-profit").textContent =
      formatNumber(totalProfit) + "원";
    document.getElementById("win-rate").textContent = winRate + "%";
    document.getElementById("avg-return").textContent = avgReturn + "%";

    // 색상 설정 (한국 주식 시장 관례: 상승=빨간색, 하락=파란색)
    const profitElement = document.getElementById("total-profit");
    const returnElement = document.getElementById("avg-return");

    if (totalProfit > 0) {
      profitElement.className = "text-up";
      returnElement.className = "text-up";
    } else if (totalProfit < 0) {
      profitElement.className = "text-down";
      returnElement.className = "text-down";
    } else {
      profitElement.className = "text-neutral";
      returnElement.className = "text-neutral";
    }
  }

  function updateDailyTradesTable(trades) {
    const tbody = document.getElementById("daily-trades-tbody");
    tbody.innerHTML = "";

    if (!trades || trades.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="9" class="text-center text-muted">표시할 데이터가 없습니다.</td></tr>';
      return;
    }

    trades.forEach((trade) => {
      const row = document.createElement("tr");
      const profit = parseFloat(trade.profit_amount || "0");
      const returnRate = parseFloat(trade.return_rate || "0");

      row.innerHTML = `
            <td>${formatDate(trade.trade_date)}</td>
            <td>${trade.trade_count || "0"}건</td>
            <td>${formatNumber(trade.buy_amount || "0")}원</td>
            <td>${formatNumber(trade.sell_amount || "0")}원</td>
            <td>${formatNumber(trade.commission || "0")}원</td>
            <td>${formatNumber(trade.tax || "0")}원</td>
            <td class="${profit >= 0 ? "text-up" : "text-down"}">
                ${formatNumber(trade.profit_amount || "0")}원
            </td>
            <td class="${returnRate >= 0 ? "text-up" : "text-down"}">
                ${parseFloat(trade.return_rate || "0").toFixed(2)}%
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showDailyDetail('${
                  trade.trade_date
                }')">
                    <i class="fas fa-info-circle"></i>
                </button>
            </td>
        `;
      tbody.appendChild(row);
    });
  }

  function updateMonthlyTradesTable(trades) {
    const tbody = document.getElementById("monthly-trades-tbody");
    tbody.innerHTML = "";

    trades.forEach((trade) => {
      const row = document.createElement("tr");
      const profit = parseFloat(trade.profit_amount || "0");
      const returnRate = parseFloat(trade.return_rate || "0");

      row.innerHTML = `
            <td>${trade.month}</td>
            <td>${trade.trade_count || "0"}건</td>
            <td>${formatNumber(trade.buy_amount || "0")}원</td>
            <td>${formatNumber(trade.sell_amount || "0")}원</td>
            <td>${formatNumber(trade.commission || "0")}원</td>
            <td>${formatNumber(trade.tax || "0")}원</td>
            <td class="${profit >= 0 ? "text-up" : "text-down"}">
                ${formatNumber(trade.profit_amount || "0")}원
            </td>
            <td class="${returnRate >= 0 ? "text-up" : "text-down"}">
                ${parseFloat(trade.return_rate || "0").toFixed(2)}%
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showMonthlyDetail('${
                  trade.month
                }')">
                    <i class="fas fa-info-circle"></i>
                </button>
            </td>
        `;
      tbody.appendChild(row);
    });
  }


  function formatDate(dateStr) {
    if (!dateStr) return "-";
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    return `${year}-${month}-${day}`;
  }

  function showDailyDetail(tradeDate) {
    fetch(`/api/account/trading/daily/${tradeDate}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.data.trades) {
          document.getElementById(
            "dailyDetailTitle"
          ).textContent = `${formatDate(tradeDate)} 매매 상세`;

          const trades = data.data.trades;
          const summary = data.data.summary || {};
          let tableHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>시간</th>
                                    <th>종목명</th>
                                    <th>구분</th>
                                    <th>수량</th>
                                    <th>단가</th>
                                    <th>매도금액</th>
                                    <th>매수금액</th>
                                    <th>수수료_세금</th>
                                    <th>손익</th>
                                    <th>수익률</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

          trades.forEach((trade) => {
            // 매도 거래만 표시 (22일은 매도만 했으므로)
            const hasSell = parseFloat(trade.sell_qty || "0") > 0;
            const isSellTrade = trade.sell_tp === '1' || hasSell;

            // 매도 거래만 표시 (매수 정보는 표시하지 않음)
            if (isSellTrade) {
              tableHTML += `
                        <tr>
                            <td>${trade.cntr_tm || "-"}</td>
                            <td>${trade.stk_nm || "-"}</td>
                            <td><span class="text-danger">매도</span></td>
                            <td>${formatNumber(trade.sell_qty || "0")}</td>
                            <td>${formatNumber(trade.sel_avg_pric || "0")}원</td>
                            <td>${formatNumber(trade.sell_amt || "0")}원</td>
                            <td>${formatNumber(trade.buy_amt || "0")}원</td>
                            <td>${formatNumber(trade.cmsn_alm_tax || "0")}원</td>
                            <td class="${
                              parseFloat(trade.pl_amt || "0") >= 0
                                ? "text-up"
                                : "text-down"
                            }">
                                ${formatNumber(trade.pl_amt || "0")}원
                            </td>
                            <td class="${
                              parseFloat(trade.prft_rt || "0") >= 0
                                ? "text-up"
                                : "text-down"
                            }">
                                ${parseFloat(trade.prft_rt || "0").toFixed(2)}%
                            </td>
                        </tr>
                    `;
            }
          });

          // 총합 행 추가
          if (summary.total_sell_amount || summary.total_buy_amount) {
            tableHTML += `
                        <tr class="table-info fw-bold">
                            <td colspan="3">총합</td>
                            <td>-</td>
                            <td>-</td>
                            <td>${formatNumber(summary.total_sell_amount || "0")}원</td>
                            <td>${formatNumber(summary.total_buy_amount || "0")}원</td>
                            <td>${formatNumber(summary.total_commission_tax || "0")}원</td>
                            <td class="${
                              parseFloat(summary.total_profit || "0") >= 0
                                ? "text-up"
                                : "text-down"
                            }">
                                ${formatNumber(summary.total_profit || "0")}원
                            </td>
                            <td class="${
                              parseFloat(summary.total_profit || "0") >= 0
                                ? "text-up"
                                : "text-down"
                            }">
                                ${summary.total_buy_amount > 0 ? 
                                  ((parseFloat(summary.total_profit || "0") / parseFloat(summary.total_buy_amount || "1")) * 100).toFixed(2) + "%" : 
                                  "0.00%"}
                            </td>
                        </tr>
                    `;
          }

          tableHTML += "</tbody></table></div>";
          document.getElementById("dailyDetailBody").innerHTML = tableHTML;
        } else {
          document.getElementById("dailyDetailBody").innerHTML =
            '<p class="text-muted">해당 날짜의 매매 내역이 없습니다.</p>';
        }
      })
      .catch((error) => {
        console.error("일별 상세 조회 실패:", error);
        document.getElementById("dailyDetailBody").innerHTML =
          '<p class="text-danger">데이터 조회에 실패했습니다.</p>';
      });

    new bootstrap.Modal(document.getElementById("dailyDetailModal")).show();
  }

  function showMonthlyDetail(month) {
    // 월별 상세 기능 (추후 구현)
    showAlert("월별 상세 기능은 추후 구현 예정입니다.", "info");
  }


  function filterTradingDiary() {
    const startDate = document.getElementById("diary-date-from").value;
    const endDate = document.getElementById("diary-date-to").value;
    const profitFilter = document.getElementById("profit-filter").value;
    const searchTerm = document
      .getElementById("diary-stock-search")
      .value.toLowerCase();

    // 날짜가 변경된 경우 서버에서 새로 로드
    if (startDate && endDate) {
      loadTradingDiary();
    }

    // 클라이언트 사이드 필터링
    let filteredData = dailyTradesData;

    if (profitFilter) {
      filteredData = filteredData.filter((trade) => {
        const profit = parseFloat(trade.profit_amount || "0");
        if (profitFilter === "profit") return profit > 0;
        if (profitFilter === "loss") return profit < 0;
        return true;
      });
    }

    // NOTE: 일별 요약(테이블/그래프)은 동일 데이터 기준으로 동기화
    currentDailyDisplayedData = filteredData.slice();
    updateDailyTradesTable(currentDailyDisplayedData);
    renderDailyProfitChart(currentDailyDisplayedData);
    renderDailyCumProfitChart(currentDailyDisplayedData);
  }

  function sortDailyTrades() {
    const sortBy = document.getElementById("sort-daily").value;

    dailyTradesData.sort((a, b) => {
      switch (sortBy) {
        case "date":
          return b.trade_date.localeCompare(a.trade_date);
        case "profit":
          return (
            parseFloat(b.profit_amount || "0") -
            parseFloat(a.profit_amount || "0")
          );
        case "return":
          return (
            parseFloat(b.return_rate || "0") - parseFloat(a.return_rate || "0")
          );
        case "count":
          return (
            parseInt(b.trade_count || "0") - parseInt(a.trade_count || "0")
          );
        default:
          return 0;
      }
    });

    currentDailyDisplayedData = dailyTradesData.slice();
    updateDailyTradesTable(currentDailyDisplayedData);
    renderDailyProfitChart(currentDailyDisplayedData);
    renderDailyCumProfitChart(currentDailyDisplayedData);
  }

  function sortMonthlyTrades() {
    const sortBy = document.getElementById("sort-monthly").value;

    monthlyTradesData.sort((a, b) => {
      switch (sortBy) {
        case "month":
          return b.month.localeCompare(a.month);
        case "profit":
          return (
            parseFloat(b.profit_amount || "0") -
            parseFloat(a.profit_amount || "0")
          );
        case "return":
          return (
            parseFloat(b.return_rate || "0") - parseFloat(a.return_rate || "0")
          );
        case "count":
          return (
            parseInt(b.trade_count || "0") - parseInt(a.trade_count || "0")
          );
        default:
          return 0;
      }
    });

    updateMonthlyTradesTable(monthlyTradesData);
  }

  function refreshTradingDiary() {
    loadTradingDiary();
    showAlert("매매일지가 새로고침되었습니다.", "success");
  }

  function exportTradingDiary() {
    const csvContent = generateTradingDiaryCSV(dailyTradesData);
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);

    link.setAttribute("href", url);
    link.setAttribute(
      "download",
      "trading_diary_" + new Date().toISOString().split("T")[0] + ".csv"
    );
    link.style.visibility = "hidden";

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showAlert("매매일지가 내보내기되었습니다.", "success");
  }

  function generateTradingDiaryCSV(data) {
    const headers = [
      "거래일",
      "매매건수",
      "매수금액",
      "매도금액",
      "수수료",
      "세금",
      "손익금액",
      "수익률",
    ];
    const rows = data.map((trade) => [
      formatDate(trade.trade_date),
      trade.trade_count || "0",
      trade.buy_amount || "0",
      trade.sell_amount || "0",
      trade.commission || "0",
      trade.tax || "0",
      trade.profit_amount || "0",
      trade.return_rate || "0",
    ]);

    return [headers, ...rows].map((row) => row.join(",")).join("\n");
  }

  // ------------------------------
  // 일별 손익 그래프 (Chart.js)
  // ------------------------------
  function _safeNumber(v, fallback = 0) {
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function _formatYYYYMMDD(dateStr) {
    if (!dateStr) return "-";
    const s = String(dateStr);
    if (s.length === 8) return `${s.substring(0, 4)}-${s.substring(4, 6)}-${s.substring(6, 8)}`;
    return s;
  }

  function renderDailyProfitChart(trades) {
    const canvas = document.getElementById("daily-profit-chart");
    if (!canvas || typeof Chart === "undefined") return;

    const rows = (trades || []).slice().sort((a, b) => {
      const ad = String(a.trade_date || "");
      const bd = String(b.trade_date || "");
      return ad.localeCompare(bd);
    });

    const labels = rows.map((t) => _formatYYYYMMDD(t.trade_date));
    const values = rows.map((t) => _safeNumber(t.profit_amount, 0));
    const colors = values.map((v) =>
      v >= 0 ? "rgba(244, 67, 54, 0.65)" : "rgba(33, 150, 243, 0.65)"
    );
    const borderColors = values.map((v) =>
      v >= 0 ? "rgba(244, 67, 54, 0.95)" : "rgba(33, 150, 243, 0.95)"
    );

    const data = {
      labels,
      datasets: [
        {
          label: "손익금액",
          data: values,
          backgroundColor: colors,
          borderColor: borderColors,
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 32,
        },
      ],
    };

    const options = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (ctx) {
              const v = _safeNumber(ctx.parsed.y, 0);
              const sign = v > 0 ? "+" : "";
              return `손익: ${sign}${formatNumber(v)}원`;
            },
          },
        },
      },
      scales: {
        x: {
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 },
          grid: { display: false },
        },
        y: {
          ticks: {
            callback: function (value) {
              return `${formatNumber(value)}원`;
            },
          },
          grid: {
            color: function (context) {
              const v = context.tick && context.tick.value;
              return v === 0 ? "rgba(0,0,0,0.28)" : "rgba(0,0,0,0.08)";
            },
          },
        },
      },
    };

    if (dailyProfitChart) {
      dailyProfitChart.data = data;
      dailyProfitChart.update();
      return;
    }

    const ctx = canvas.getContext("2d");
    dailyProfitChart = new Chart(ctx, {
      type: "bar",
      data,
      options,
    });
  }

  // ------------------------------
  // 누적 손익 그래프 (Chart.js - Line)
  // ------------------------------
  function renderDailyCumProfitChart(trades) {
    const canvas = document.getElementById("daily-cum-profit-chart");
    if (!canvas || typeof Chart === "undefined") return;

    const rows = (trades || []).slice().sort((a, b) => {
      const ad = String(a.trade_date || "");
      const bd = String(b.trade_date || "");
      return ad.localeCompare(bd);
    });

    const labels = rows.map((t) => _formatYYYYMMDD(t.trade_date));
    const dailyValues = rows.map((t) => _safeNumber(t.profit_amount, 0));
    const cumValues = [];
    let cum = 0;
    for (const v of dailyValues) {
      cum += v;
      cumValues.push(cum);
    }

    const data = {
      labels,
      datasets: [
        {
          label: "누적 손익금액",
          data: cumValues,
          borderColor: "rgba(33, 150, 243, 0.95)",
          backgroundColor: "rgba(33, 150, 243, 0.10)",
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 4,
          tension: 0.25,
          fill: true,
        },
      ],
    };

    const options = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (ctx) {
              const v = _safeNumber(ctx.parsed.y, 0);
              const sign = v > 0 ? "+" : "";
              return `누적손익: ${sign}${formatNumber(v)}원`;
            },
          },
        },
      },
      scales: {
        x: {
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 },
          grid: { display: false },
        },
        y: {
          ticks: {
            callback: function (value) {
              return `${formatNumber(value)}원`;
            },
          },
          grid: {
            color: function (context) {
              const v = context.tick && context.tick.value;
              return v === 0 ? "rgba(0,0,0,0.28)" : "rgba(0,0,0,0.08)";
            },
          },
        },
      },
    };

    if (dailyCumProfitChart) {
      dailyCumProfitChart.data = data;
      dailyCumProfitChart.update();
      return;
    }

    const ctx = canvas.getContext("2d");
    dailyCumProfitChart = new Chart(ctx, {
      type: "line",
      data,
      options,
    });
  }
</script>
{% endblock %}
