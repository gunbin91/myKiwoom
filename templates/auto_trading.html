{% extends "base.html" %} {% block title %}ìë™ë§¤ë§¤ - í‚¤ì›€ ìë™ë§¤ë§¤{% endblock
%} {% block content %}
<div class="row">
  <!-- ìë™ë§¤ë§¤ ìƒíƒœ ì¹´ë“œ -->
  <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 mb-4">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">ìë™ë§¤ë§¤ ìƒíƒœ</h6>
            <h6 class="mb-0" id="auto-trading-status">OFF</h6>
          </div>
          <div class="align-self-center">
            <i class="fas fa-robot fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ìŠ¤ì¼€ì¤„ëŸ¬ ì²´í¬ ì¹´ë“œ -->
  <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 mb-4">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">ìŠ¤ì¼€ì¤„ëŸ¬ ì²´í¬</h6>
            <h6 class="mb-0" id="scheduler-check">-</h6>
          </div>
          <div class="align-self-center">
            <i class="fas fa-sync-alt fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë§ˆì§€ë§‰ ì‹¤í–‰ ì¹´ë“œ -->
  <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 mb-4">
    <div class="card bg-info text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">ë§ˆì§€ë§‰ ì‹¤í–‰</h6>
            <h6 class="mb-0" id="last-execution">-</h6>
          </div>
          <div class="align-self-center">
            <i class="fas fa-clock fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì˜¤ëŠ˜ ì‹¤í–‰ ì—¬ë¶€ ì¹´ë“œ -->
  <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 mb-4">
    <div class="card bg-success text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">ì˜¤ëŠ˜ ì‹¤í–‰ ì—¬ë¶€</h6>
            <h6 class="mb-0" id="today-execution">-</h6>
          </div>
          <div class="align-self-center">
            <i class="fas fa-calendar-check fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì‹¤í–‰ ì§„í–‰ ìƒí™© í‘œì‹œ -->
<div class="row mb-4" id="execution-progress" style="display: none">
  <div class="col-12">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
          <i class="fas fa-cog fa-spin me-2"></i>ìë™ë§¤ë§¤ ì‹¤í–‰ ì¤‘
        </h6>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span id="current-status">ì‹œì‘ ì¤‘...</span>
          <span id="progress-percentage">0%</span>
        </div>
        <div class="progress">
          <div
            class="progress-bar progress-bar-striped progress-bar-animated"
            id="progress-bar"
            role="progressbar"
            style="width: 0%"
          ></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- ìë™ë§¤ë§¤ ì„¤ì • -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>ìë™ë§¤ë§¤ ì„¤ì •</h5>
      </div>
      <div class="card-body">
        <form id="auto-trading-config-form">
          <!-- ìë™ë§¤ë§¤ ON/OFF -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="auto-trading-enabled"
              />
              <label class="form-check-label" for="auto-trading-enabled">
                ìë™ë§¤ë§¤ í™œì„±í™”
              </label>
            </div>
          </div>

          <!-- ìŠ¤ì¼€ì¤„ ì„¤ì • -->
          <div class="mb-3">
            <label class="form-label">ì‹¤í–‰ ì‹œê°„</label>
            <div class="row">
              <div class="col-6">
                <select class="form-select" id="schedule-hour">
                  <option value="00">00ì‹œ</option>
                  <option value="01">01ì‹œ</option>
                  <option value="02">02ì‹œ</option>
                  <option value="03">03ì‹œ</option>
                  <option value="04">04ì‹œ</option>
                  <option value="05">05ì‹œ</option>
                  <option value="06">06ì‹œ</option>
                  <option value="07">07ì‹œ</option>
                  <option value="08">08ì‹œ</option>
                  <option value="09">09ì‹œ</option>
                  <option value="10">10ì‹œ</option>
                  <option value="11">11ì‹œ</option>
                  <option value="12">12ì‹œ</option>
                  <option value="13">13ì‹œ</option>
                  <option value="14">14ì‹œ</option>
                  <option value="15">15ì‹œ</option>
                  <option value="16">16ì‹œ</option>
                  <option value="17">17ì‹œ</option>
                  <option value="18">18ì‹œ</option>
                  <option value="19">19ì‹œ</option>
                  <option value="20">20ì‹œ</option>
                  <option value="21">21ì‹œ</option>
                  <option value="22">22ì‹œ</option>
                  <option value="23">23ì‹œ</option>
                </select>
              </div>
              <div class="col-6">
                <select class="form-select" id="schedule-minute">
                  <option value="00">00ë¶„</option>
                  <option value="05">05ë¶„</option>
                  <option value="10">10ë¶„</option>
                  <option value="15">15ë¶„</option>
                  <option value="20">20ë¶„</option>
                  <option value="25">25ë¶„</option>
                  <option value="30">30ë¶„</option>
                  <option value="35">35ë¶„</option>
                  <option value="40">40ë¶„</option>
                  <option value="45">45ë¶„</option>
                  <option value="50">50ë¶„</option>
                  <option value="55">55ë¶„</option>
                </select>
              </div>
            </div>
            <div class="form-text" id="next-execution-info">
              ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ì„ ê³„ì‚°í•˜ëŠ” ì¤‘...
            </div>
          </div>

          <!-- ì „ëµ ì„¤ì • -->
          <div class="mb-3">
            <label for="reserve-cash" class="form-label"
              >ë§¤ë§¤ ì œì™¸ ì˜ˆìˆ˜ê¸ˆ (ì›)</label
            >
            <input
              type="number"
              class="form-control"
              id="reserve-cash"
              min="0"
              step="1000"
              value="1000000"
            />
            <div class="form-text">
              ì´ ê¸ˆì•¡ì€ ë§¤ë§¤ì—ì„œ ì œì™¸í•˜ê³  ë³´ìœ í•©ë‹ˆë‹¤. (0ì› ê°€ëŠ¥)
            </div>
          </div>

          <div class="mb-3">
            <label for="max-hold-period" class="form-label"
              >ìµœëŒ€ ë³´ìœ  ê¸°ê°„ (ì¼)</label
            >
            <input
              type="number"
              class="form-control"
              id="max-hold-period"
              min="1"
              value="15"
            />
          </div>

          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="take-profit-pct" class="form-label"
                  >ìµì ˆë¥  (%)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="take-profit-pct"
                  min="0.1"
                  step="0.1"
                  value="5.0"
                />
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label for="stop-loss-pct" class="form-label">ì†ì ˆë¥  (%)</label>
                <input
                  type="number"
                  class="form-control"
                  id="stop-loss-pct"
                  min="0.1"
                  step="0.1"
                  value="3.0"
                />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="top-n" class="form-label">ë§¤ìˆ˜ ì¢…ëª© ìˆ˜</label>
                <input
                  type="number"
                  class="form-control"
                  id="top-n"
                  min="1"
                  value="5"
                />
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label for="buy-universe-rank" class="form-label"
                  >ë§¤ìˆ˜ ëŒ€ìƒ ë²”ìœ„</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="buy-universe-rank"
                  min="1"
                  value="20"
                />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="transaction-fee-rate" class="form-label"
                  >ê±°ë˜ ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="transaction-fee-rate"
                  min="0"
                  max="1"
                  step="0.001"
                  value="0.015"
                />
                <div class="form-text">ê¸°ë³¸ê°’: 0.015% (í‚¤ì›€ì¦ê¶Œ ê¸°ì¤€)</div>
              </div>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>ì„¤ì • ì €ì¥
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ì‹¤í–‰ ì œì–´ -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-play me-2"></i>ì‹¤í–‰ ì œì–´</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-info" id="test-analysis-btn">
            <i class="fas fa-search me-1"></i>ë¶„ì„ ê²°ê³¼ í™•ì¸
          </button>
          <button type="button" class="btn btn-success" id="manual-execute-btn">
            <i class="fas fa-play me-1"></i>ìˆ˜ë™ ì‹¤í–‰
          </button>
          <button type="button" class="btn btn-warning" id="emergency-stop-btn">
            <i class="fas fa-stop me-1"></i>ê¸´ê¸‰ ì¤‘ì§€
          </button>
        </div>

        <hr />

        <h6>ì‹¤í–‰ ì´ë ¥</h6>
        <div class="table-responsive">
          <table class="table table-sm" id="execution-history-table">
            <thead>
              <tr>
                <th>ì‹¤í–‰ì¼ì‹œ</th>
                <th>êµ¬ë¶„</th>
                <th>ìƒíƒœ</th>
                <th>ë§¤ìˆ˜</th>
                <th>ë§¤ë„</th>
              </tr>
            </thead>
            <tbody id="execution-history-tbody">
              <tr>
                <td colspan="5" class="text-center text-muted">
                  ì‹¤í–‰ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ìˆ˜ë™ ì‹¤í–‰ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="manualExecuteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0">
        <h5 class="modal-title">
          <i class="fas fa-play-circle me-2"></i>ìˆ˜ë™ ì‹¤í–‰ í™•ì¸
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <div class="mb-3">
            <i class="fas fa-robot fa-3x text-primary"></i>
          </div>
          <h6 class="mb-3">ìë™ë§¤ë§¤ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h6>
        </div>

        <div class="alert alert-warning border-0 shadow-sm">
          <div class="d-flex align-items-start">
            <i class="fas fa-exclamation-triangle text-warning me-3 mt-1"></i>
            <div>
              <strong>ì£¼ì˜ì‚¬í•­:</strong>
              <ul class="mb-0 mt-2">
                <li>ì‹¤ì œ ì£¼ë¬¸ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                <li>í˜„ì¬ ì„¤ì •ëœ ì „ëµìœ¼ë¡œ ë§¤ë§¤ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤</li>
                <li>ì‹ ì¤‘íˆ ê²°ì •í•´ì£¼ì„¸ìš”</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          <i class="fas fa-times me-1"></i>ì·¨ì†Œ
        </button>
        <button
          type="button"
          class="btn btn-primary"
          id="confirm-manual-execute"
        >
          <i class="fas fa-play me-1"></i>ì‹¤í–‰
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ë¶„ì„ ê²°ê³¼ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="analysisResultModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-info text-white border-0">
        <h5 class="modal-title">
          <i class="fas fa-chart-line me-2"></i>ë¶„ì„ ê²°ê³¼ í™•ì¸
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4">
        <!-- ë¶„ì„ ì •ë³´ -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title">ë¶„ì„ ì •ë³´</h6>
                <p class="mb-1">
                  <strong>ë¶„ì„ ë‚ ì§œ:</strong> <span id="analysis-date">-</span>
                </p>
                <p class="mb-1">
                  <strong>ì´ ì¢…ëª© ìˆ˜:</strong> <span id="total-stocks">-</span>
                </p>
                <p class="mb-0">
                  <strong>ë§¤ìˆ˜ ëŒ€ìƒ:</strong>
                  <span id="buy-candidates-count">-</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title">ì „ëµ íŒŒë¼ë¯¸í„°</h6>
                <p class="mb-1">
                  <strong>ë§¤ìˆ˜ ì¢…ëª© ìˆ˜:</strong>
                  <span id="strategy-top-n">-</span>
                </p>
                <p class="mb-1">
                  <strong>ë§¤ìˆ˜ ë²”ìœ„:</strong>
                  <span id="strategy-universe">-</span>
                </p>
                <p class="mb-1">
                  <strong>ìˆ˜ìˆ˜ë£Œìœ¨:</strong>
                  <span id="strategy-fee-rate">-</span>
                </p>
                <p class="mb-1">
                  <strong>ì˜ˆì•½ í˜„ê¸ˆ:</strong>
                  <span id="strategy-reserve">-</span>
                </p>
                <p class="mb-0">
                  <strong>ì‚¬ìš©ê°€ëŠ¥ê¸ˆì•¡:</strong>
                  <span id="available-cash" class="text-primary fw-bold"
                    >-</span
                  >
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- ìƒìœ„ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ -->
        <div class="mb-4">
          <h6 style="color: black;">ìƒìœ„ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ìƒìœ„ 20ê°œ)</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover" id="top-stocks-table">
              <thead class="table-light">
                <tr>
                  <th>ìˆœìœ„</th>
                  <th>ì¢…ëª©ëª…</th>
                  <th>ì¢…ëª©ì½”ë“œ</th>
                  <th>í˜„ì¬ê°€</th>
                  <th>ìµœì¢…ì ìˆ˜</th>
                  <th>ìƒìŠ¹í™•ë¥ </th>
                </tr>
              </thead>
              <tbody id="top-stocks-tbody">
                <tr>
                  <td colspan="6" class="text-center text-muted">
                    ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ë§¤ë„ ëŒ€ìƒ ì¢…ëª© -->
        <div class="mb-4">
          <h6 style="color: black;">ë§¤ë„ ëŒ€ìƒ ì¢…ëª©</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover" id="sell-candidates-table">
              <thead class="table-danger">
                <tr>
                  <th>ì¢…ëª©ëª…</th>
                  <th>ì¢…ëª©ì½”ë“œ</th>
                  <th>ë³´ìœ ìˆ˜ëŸ‰</th>
                  <th>í‰ê· ë‹¨ê°€</th>
                  <th>í˜„ì¬ê°€</th>
                  <th>ìˆ˜ìµë¥ </th>
                  <th>ë³´ìœ ê¸°ê°„</th>
                  <th>ë§¤ë„ì˜ˆìƒê¸ˆì•¡</th>
                  <th>ë§¤ë„ì‚¬ìœ </th>
                </tr>
              </thead>
              <tbody id="sell-candidates-tbody">
                <tr>
                  <td colspan="9" class="text-center text-muted">
                    ë§¤ë„ ëŒ€ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ë§¤ìˆ˜ ëŒ€ìƒ ì¢…ëª© (ë§¤ë„ í›„) -->
        <div class="mb-4">
          <h6 style="color: black;">ë§¤ìˆ˜ ëŒ€ìƒ ì¢…ëª© (ë§¤ë„ í›„)</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover" id="buy-candidates-table">
              <thead class="table-success">
                <tr>
                  <th>ìˆœìœ„</th>
                  <th>ì¢…ëª©ëª…</th>
                  <th>ì¢…ëª©ì½”ë“œ</th>
                  <th>í˜„ì¬ê°€</th>
                  <th>ìµœì¢…ì ìˆ˜</th>
                  <th>ìƒìŠ¹í™•ë¥ </th>
                </tr>
              </thead>
              <tbody id="buy-candidates-tbody">
                <tr>
                  <td colspan="6" class="text-center text-muted">
                    ë§¤ìˆ˜ ëŒ€ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          <i class="fas fa-times me-1"></i>ë‹«ê¸°
        </button>
        <button
          type="button"
          class="btn btn-success"
          id="execute-with-candidates"
        >
          <i class="fas fa-play me-1"></i>ë§¤ë„ í›„ ë§¤ìˆ˜ ì‹¤í–‰
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ê¸´ê¸‰ ì¤‘ì§€ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="emergencyStopModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white border-0">
        <h5 class="modal-title">
          <i class="fas fa-stop-circle me-2"></i>ê¸´ê¸‰ ì¤‘ì§€ í™•ì¸
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <div class="mb-3">
            <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
          </div>
          <h6 class="mb-3">ìë™ë§¤ë§¤ë¥¼ ê¸´ê¸‰ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h6>
        </div>

        <div class="alert alert-danger border-0 shadow-sm">
          <div class="d-flex align-items-start">
            <i class="fas fa-exclamation-triangle text-danger me-3 mt-1"></i>
            <div>
              <strong>ì£¼ì˜ì‚¬í•­:</strong>
              <ul class="mb-0 mt-2">
                <li>ì§„í–‰ ì¤‘ì¸ ìë™ë§¤ë§¤ê°€ ì¦‰ì‹œ ì¤‘ë‹¨ë©ë‹ˆë‹¤</li>
                <li>ë¯¸ì²´ê²° ì£¼ë¬¸ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤</li>
                <li>ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          <i class="fas fa-times me-1"></i>ì·¨ì†Œ
        </button>
        <button
          type="button"
          class="btn btn-danger"
          id="confirm-emergency-stop"
        >
          <i class="fas fa-stop me-1"></i>ì¤‘ì§€
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<style>
  /* ìë™ë§¤ë§¤ ìƒíƒœ ì¹´ë“œ ìŠ¤íƒ€ì¼ */

  /* ì ì´ ëŠ˜ì–´ë‚˜ëŠ” ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
  .loading-dots {
    display: inline-flex;
    align-items: center;
    gap: 2px;
  }

  .loading-dots .dot {
    width: 4px;
    height: 4px;
    background-color: currentColor;
    border-radius: 50%;
    animation: loading-dots 1.5s infinite ease-in-out;
  }

  .loading-dots .dot:nth-child(1) {
    animation-delay: 0s;
  }

  .loading-dots .dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .loading-dots .dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes loading-dots {
    0%,
    80%,
    100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1.2);
      opacity: 1;
    }
  }

  /* ìƒíƒœ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
  #auto-trading-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* ë³´ë¼ìƒ‰ ë°°ê²½ (ON ìƒíƒœ) */
  .bg-purple {
    background-color: #6f42c1 !important;
  }

  .bg-purple:hover {
    background-color: #5a32a3 !important;
  }
</style>
<script>
  // ìë™ë§¤ë§¤ í˜ì´ì§€ ì „ìš© JavaScript
  document.addEventListener("DOMContentLoaded", function () {
    // ì„œë²„ ì •ë³´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    updateServerInfoFromTemplate();

    loadAutoTradingConfig();
    loadExecutionHistory();
    updateAutoTradingStatus(); // ì´ˆê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
    updateNextExecutionInfo(); // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸

    // 30ì´ˆë§ˆë‹¤ ìƒíƒœ ì—…ë°ì´íŠ¸
    setInterval(updateAutoTradingStatus, 30000);

    // ì‹œê°„ ë³€ê²½ ì‹œ ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸
    document.getElementById("schedule-hour").addEventListener("change", updateNextExecutionInfo);
    document.getElementById("schedule-minute").addEventListener("change", updateNextExecutionInfo);
  });

  function updateServerInfoFromTemplate() {
    // í…œí”Œë¦¿ì—ì„œ ì „ë‹¬ë°›ì€ ì„œë²„ ì •ë³´ë¡œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    {% if server_info %}
    const serverNameElement = document.getElementById('server-name');
    const serverInfoElement = document.getElementById('server-info');

    if (serverNameElement && serverInfoElement) {
      serverNameElement.textContent = '{{ server_info.server_name }}';

      // ì„œë²„ë³„ ìƒ‰ìƒ ì ìš©
      if ('{{ server_info.server_type }}' === 'mock') {
        serverInfoElement.style.color = '#4CAF50';
      } else {
        serverInfoElement.style.color = '#F44336';
      }
    }
    {% endif %}
  }

  // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì •ë³´ ì—…ë°ì´íŠ¸
  function updateNextExecutionInfo() {
    const hour = document.getElementById("schedule-hour").value;
    const minute = document.getElementById("schedule-minute").value;
    const scheduleTime = `${hour}:${minute}`;

    // í˜„ì¬ ì‹œê°„ê³¼ ë¹„êµí•˜ì—¬ ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const scheduledTime = new Date(today.getTime() + parseInt(hour) * 60 * 60 * 1000 + parseInt(minute) * 60 * 1000);

    let nextExecutionDate;
    let executionStatus;

    if (scheduledTime > now) {
      // ì˜¤ëŠ˜ ì‹¤í–‰ ì˜ˆì •
      nextExecutionDate = scheduledTime;
      executionStatus = "ì˜¤ëŠ˜";
    } else {
      // ë‚´ì¼ ì‹¤í–‰ ì˜ˆì •
      nextExecutionDate = new Date(scheduledTime.getTime() + 24 * 60 * 60 * 1000);
      executionStatus = "ë‚´ì¼";
    }

    const year = nextExecutionDate.getFullYear();
    const month = (nextExecutionDate.getMonth() + 1).toString().padStart(2, '0');
    const day = nextExecutionDate.getDate().toString().padStart(2, '0');
    const timeStr = `${hour}ì‹œ ${minute}ë¶„`;

    const infoElement = document.getElementById("next-execution-info");
    infoElement.innerHTML = `ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„: ${year}ë…„ ${month}ì›” ${day}ì¼ ${timeStr} (${executionStatus})`;
  }

  // ì„¤ì • ë¡œë“œ
  function loadAutoTradingConfig() {
    fetch("/api/auto-trading/config")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const config = data.data;
          document.getElementById("auto-trading-enabled").checked =
            config.auto_trading_enabled;

          // ì‹œê°„ ì„¤ì • ë¡œë“œ
          const scheduleTime = config.schedule_time || "08:30";
          const [hour, minute] = scheduleTime.split(':');
          document.getElementById("schedule-hour").value = hour;
          document.getElementById("schedule-minute").value = minute;

          // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸
          updateNextExecutionInfo();
          document.getElementById("reserve-cash").value =
            config.strategy_params?.reserve_cash ?? 1000000;
          document.getElementById("max-hold-period").value =
            config.strategy_params?.max_hold_period || 15;
          document.getElementById("take-profit-pct").value =
            config.strategy_params?.take_profit_pct || 5.0;
          document.getElementById("stop-loss-pct").value =
            config.strategy_params?.stop_loss_pct || 3.0;
          document.getElementById("top-n").value =
            config.strategy_params?.top_n || 5;
          document.getElementById("buy-universe-rank").value =
            config.strategy_params?.buy_universe_rank || 20;
          document.getElementById("transaction-fee-rate").value =
            config.strategy_params?.transaction_fee_rate || 0.015;
        }
      })
      .catch((error) => {
        console.error("ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:", error);
        showAlert("ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "danger");
      });
  }

  // ì„¤ì • ì €ì¥
  document
    .getElementById("auto-trading-config-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      // ì‹œê°„ ì„¤ì • ì¡°í•©
      const hour = document.getElementById("schedule-hour").value;
      const minute = document.getElementById("schedule-minute").value;
      const scheduleTime = `${hour}:${minute}`;

      const config = {
        auto_trading_enabled: document.getElementById("auto-trading-enabled")
          .checked,
        schedule_time: scheduleTime,
        strategy_params: {
          reserve_cash:
            parseInt(document.getElementById("reserve-cash").value) || 0,
          max_hold_period:
            parseInt(document.getElementById("max-hold-period").value) || 15,
          take_profit_pct:
            parseFloat(document.getElementById("take-profit-pct").value) || 5.0,
          stop_loss_pct:
            parseFloat(document.getElementById("stop-loss-pct").value) || 3.0,
          top_n: parseInt(document.getElementById("top-n").value) || 5,
          buy_universe_rank:
            parseInt(document.getElementById("buy-universe-rank").value) || 20,
          transaction_fee_rate:
            parseFloat(document.getElementById("transaction-fee-rate").value) || 0.015,
        },
      };

      console.log("ì €ì¥í•  ì„¤ì •:", config);

      fetch("/api/auto-trading/config", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(config),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            // ì„¤ì • ì €ì¥ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAutoTradingStatus();
            loadExecutionHistory();
          } else {
            showAlert(data.message || "ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "danger");
          }
        })
        .catch((error) => {
          console.error("ì„¤ì • ì €ì¥ ì‹¤íŒ¨:", error);
          showAlert("ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "danger");
        });
    });

  // ìë™ë§¤ë§¤ ìƒíƒœ ì—…ë°ì´íŠ¸
  function updateAutoTradingStatus() {
    fetch("/api/auto-trading/status")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const status = data.data;
          const statusElement = document.getElementById("auto-trading-status");
          const statusCard = statusElement.closest(".card");

          if (status.enabled) {
            statusElement.innerHTML = `
                        <span>ON</span>
                        <div class="loading-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    `;
            statusCard.className = "card bg-purple text-white";
          } else {
            statusElement.innerHTML = "OFF";
            statusCard.className = "card bg-secondary text-white";
          }

          document.getElementById("last-execution").textContent =
            status.last_execution || "-";
          document.getElementById("today-execution").textContent =
            status.today_executed ? "ì‹¤í–‰ë¨" : "ë¯¸ì‹¤í–‰";
          document.getElementById("scheduler-check").textContent =
            status.last_check_time || "-";

          // ì‹¤í–‰ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
          updateExecutionProgress(status);
        }
      })
      .catch((error) => {
        console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
      });
  }

  // ì‹¤í–‰ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
  function updateExecutionProgress(status) {
    const progressCard = document.getElementById("execution-progress");
    const currentStatus = document.getElementById("current-status");
    const progressPercentage = document.getElementById("progress-percentage");
    const progressBar = document.getElementById("progress-bar");

    if (status.is_running) {
      progressCard.style.display = "block";
      currentStatus.textContent = status.current_status || "ì‹¤í–‰ ì¤‘...";
      progressPercentage.textContent = (status.progress_percentage || 0) + "%";
      progressBar.style.width = (status.progress_percentage || 0) + "%";
    } else {
      progressCard.style.display = "none";
    }
  }

  // ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
  function startProgressMonitoring() {
    const interval = setInterval(() => {
      updateAutoTradingStatus();

      // ì‹¤í–‰ì´ ì™„ë£Œë˜ë©´ ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨
      fetch("/api/auto-trading/status")
        .then((response) => response.json())
        .then((data) => {
          if (data.success && !data.data.is_running) {
            clearInterval(interval);
          }
        })
        .catch((error) => {
          console.error("ì§„í–‰ ìƒí™© í™•ì¸ ì‹¤íŒ¨:", error);
          clearInterval(interval);
        });
    }, 1000); // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
  }

  // ì‹¤í–‰ ì´ë ¥ ë¡œë“œ
  function loadExecutionHistory() {
    fetch("/api/auto-trading/history")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const tbody = document.getElementById("execution-history-tbody");
          tbody.innerHTML = "";

          if (data.data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="text-center text-muted">ì‹¤í–‰ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          } else {
            data.data.forEach((execution) => {
              const row = document.createElement("tr");

              // ì‹¤í–‰ êµ¬ë¶„ íŒŒì‹±
              let executionType = "ìë™";
              let typeBadgeClass = "bg-info";
              if (execution.message && execution.message.includes("[ìˆ˜ë™]")) {
                executionType = "ìˆ˜ë™";
                typeBadgeClass = "bg-warning";
              }

              row.innerHTML = `
                            <td>${execution.execution_time}</td>
                            <td><span class="badge ${typeBadgeClass}">${executionType}</span></td>
                            <td><span class="badge ${
                              execution.status === "success"
                                ? "bg-success"
                                : "bg-danger"
                            }">${execution.status}</span></td>
                            <td>${execution.buy_count || 0}</td>
                            <td>${execution.sell_count || 0}</td>
                        `;
              tbody.appendChild(row);
            });
          }
        }
      })
      .catch((error) => {
        console.error("ì‹¤í–‰ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:", error);
      });
  }

  // ë¶„ì„ ê²°ê³¼ í™•ì¸
  document
    .getElementById("test-analysis-btn")
    .addEventListener("click", function () {
      const button = this;
      const originalText = button.innerHTML;

      button.disabled = true;
      button.innerHTML =
        '<i class="fas fa-spinner fa-spin me-1"></i>ì¸ì¦ í™•ì¸ ì¤‘...';

      // ë¨¼ì € ì¸ì¦ ìƒíƒœ í™•ì¸
      fetch("/api/auth/status")
        .then((response) => response.json())
        .then((authData) => {
          if (!authData.success) {
            showAlert(`ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${authData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, "danger");
            button.disabled = false;
            button.innerHTML = originalText;
            return;
          }

          if (!authData.authenticated) {
            showAlert("í‚¤ì›€ API ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.", "warning");
            button.disabled = false;
            button.innerHTML = originalText;
            return;
          }

          // ì¸ì¦ì´ ì™„ë£Œëœ ê²½ìš° ë¶„ì„ ì‹œì‘
          button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ë¶„ì„ ì¤‘...';

          // ë¶„ì„ ê²°ê³¼ ì¡°íšŒ
          return fetch("/api/auto-trading/analysis", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              force_realtime: true,
            }),
          });
        })
        .catch((error) => {
          console.error("ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
          showAlert("ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "danger");
          button.disabled = false;
          button.innerHTML = originalText;
        })
        .then((response) => {
          if (!response) return; // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
          return response.json();
        })
        .then((data) => {
          if (!data) return; // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
          if (data.success) {
            // ë¶„ì„ ê²°ê³¼ë¥¼ ëª¨ë‹¬ì— í‘œì‹œ
            displayAnalysisResult(data);
            const modal = new bootstrap.Modal(
              document.getElementById("analysisResultModal")
            );
            modal.show();
          } else {
            // ìƒì„¸í•œ ì˜¤ë¥˜ ì •ë³´ í‘œì‹œ
            let errorMessage = data.message || "ë¶„ì„ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            if (data.error_details) {
              errorMessage += `\nì˜¤ë¥˜ íƒ€ì…: ${data.error_details.error_type}`;
              errorMessage += `\nì‹œê°„: ${data.error_details.timestamp}`;
            }
            console.error("ë¶„ì„ ì‹¤í–‰ ì‹¤íŒ¨:", data);

            // ì˜¤ë¥˜ íƒ€ì…ì— ë”°ë¥¸ ë‹¤ë¥¸ ë©”ì‹œì§€ í‘œì‹œ
            if (data.error_details && data.error_details.error_type === 'auth_required') {
              showAlert("í‚¤ì›€ API ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.", "warning");
            } else {
              showAlert(errorMessage, "danger");
            }
          }
        })
        .catch((error) => {
          console.error("ë¶„ì„ ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨:", error);
          showAlert(`ë¶„ì„ ê²°ê³¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, "danger");
        })
        .finally(() => {
          button.disabled = false;
          button.innerHTML = originalText;
        });
    });

  // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
  function displayAnalysisResult(data) {
    // ë¶„ì„ ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë§¤ë§¤ ì‹¤í–‰ ì‹œ ì‚¬ìš©)
    window.currentAnalysisResult = data;
    
    // ë””ë²„ê¹…: analysis_result ê°ì²´ í™•ì¸
    console.log("ë¶„ì„ ê²°ê³¼ ì €ì¥:", data);
    console.log("analysis_result ê°ì²´:", data.analysis_result);
    
    // ë¶„ì„ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById("analysis-date").textContent =
      data.analysis_date || "-";
    document.getElementById("total-stocks").textContent =
      data.total_stocks || 0;
    document.getElementById("buy-candidates-count").textContent =
      data.buy_candidates ? data.buy_candidates.length : 0;

    // ì „ëµ íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸
    const strategy = data.strategy_params || {};
    document.getElementById("strategy-top-n").textContent =
      strategy.top_n || "-";
    document.getElementById("strategy-universe").textContent =
      strategy.buy_universe_rank || "-";
    document.getElementById("strategy-fee-rate").textContent =
      strategy.transaction_fee_rate ? `${strategy.transaction_fee_rate}%` : "-";
    document.getElementById("strategy-reserve").textContent =
      strategy.reserve_cash
        ? (strategy.reserve_cash / 10000).toFixed(0) + "ë§Œì›"
        : "-";

    // ğŸ’° ì‚¬ìš©ê°€ëŠ¥ê¸ˆì•¡ ì—…ë°ì´íŠ¸
    const cashInfo = data.cash_info || {};
    const availableCash = cashInfo.available_cash || 0;
    document.getElementById("available-cash").textContent =
      availableCash > 0
        ? (availableCash / 10000).toFixed(0) + "ë§Œì›"
        : "0ì›";

    // ìƒìœ„ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    const topStocksTbody = document.getElementById("top-stocks-tbody");
    topStocksTbody.innerHTML = "";

    if (data.top_stocks && data.top_stocks.length > 0) {
      data.top_stocks.forEach((stock) => {
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>${stock.ìµœì¢…ìˆœìœ„ || "-"}</td>
                <td>${stock.ì¢…ëª©ëª… || "-"}</td>
                <td>${stock.ì¢…ëª©ì½”ë“œ || "-"}</td>
                <td>${
                  stock.í˜„ì¬ê°€ ? stock.í˜„ì¬ê°€.toLocaleString() + "ì›" : "-"
                }</td>
                <td>${
                  stock.final_score ? stock.final_score.toFixed(2) : "-"
                }</td>
                <td>${
                  stock.ml_pred_proba
                    ? (stock.ml_pred_proba * 100).toFixed(1) + "%"
                    : "-"
                }</td>
            `;
        topStocksTbody.appendChild(row);
      });
    } else {
      topStocksTbody.innerHTML =
        '<tr><td colspan="6" class="text-center text-muted">ìƒìœ„ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }

    // ë§¤ë„ ëŒ€ìƒ ì¢…ëª© ì—…ë°ì´íŠ¸
    const sellCandidatesTbody = document.getElementById("sell-candidates-tbody");
    sellCandidatesTbody.innerHTML = "";

    if (data.sell_candidates && data.sell_candidates.length > 0) {
      data.sell_candidates.forEach((stock) => {
        const row = document.createElement("tr");
        const profitRate = stock.ìˆ˜ìµë¥  || 0;
        const profitClass = profitRate > 0 ? "text-up" : profitRate < 0 ? "text-down" : "text-neutral";
        
        // ë§¤ë„ì‚¬ìœ ì— ë”°ë¥¸ ë°°ì§€ ìƒ‰ìƒ ê²°ì •
        let badgeClass = "bg-danger"; // ê¸°ë³¸ê°’: ë¹¨ê°„ìƒ‰ (ìµì ˆ)
        const sellReason = stock.ë§¤ë„ì‚¬ìœ  || "";
        if (sellReason.includes("ì†ì ˆ")) {
            badgeClass = "bg-primary"; // íŒŒë€ìƒ‰ (ì†ì ˆ)
        } else if (sellReason.includes("ë³´ìœ ê¸°ê°„")) {
            badgeClass = "bg-hotpink"; // í•«í•‘í¬ (ë³´ìœ ê¸°ê°„ ì´ˆê³¼)
        }
        
        row.innerHTML = `
                <td>${stock.ì¢…ëª©ëª… || "-"}</td>
                <td>${stock.ì¢…ëª©ì½”ë“œ || "-"}</td>
                <td>${stock.ë³´ìœ ìˆ˜ëŸ‰ ? stock.ë³´ìœ ìˆ˜ëŸ‰.toLocaleString() + "ì£¼" : "-"}</td>
                <td>${stock.í‰ê· ë‹¨ê°€ ? stock.í‰ê· ë‹¨ê°€.toLocaleString() + "ì›" : "-"}</td>
                <td>${stock.í˜„ì¬ê°€ ? stock.í˜„ì¬ê°€.toLocaleString() + "ì›" : "-"}</td>
                <td class="${profitClass}">${profitRate.toFixed(2)}%</td>
                <td class="text-center">
                    ${(stock.ë³´ìœ ê¸°ê°„ === -1 || stock.ë³´ìœ ê¸°ê°„ === '-1' || stock.ë³´ìœ ê¸°ê°„ === null || stock.ë³´ìœ ê¸°ê°„ === undefined)
                        ? '<span class="badge bg-secondary text-white">ì•Œ ìˆ˜ ì—†ìŒ</span>'
                        : `<span class="badge bg-primary text-white">${stock.ë³´ìœ ê¸°ê°„ || 0}ì¼</span>`
                    }
                </td>
                <td>${stock.ë§¤ë„ì˜ˆìƒê¸ˆì•¡ ? stock.ë§¤ë„ì˜ˆìƒê¸ˆì•¡.toLocaleString() + "ì›" : "-"}</td>
                <td><span class="badge ${badgeClass} text-white">${stock.ë§¤ë„ì‚¬ìœ  || "-"}</span></td>
            `;
        sellCandidatesTbody.appendChild(row);
      });
    } else {
      sellCandidatesTbody.innerHTML =
        '<tr><td colspan="9" class="text-center text-muted">ë§¤ë„ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }

    // ë§¤ìˆ˜ ëŒ€ìƒ ì¢…ëª© ì—…ë°ì´íŠ¸
    const buyCandidatesTbody = document.getElementById("buy-candidates-tbody");
    buyCandidatesTbody.innerHTML = "";

    if (data.buy_candidates && data.buy_candidates.length > 0) {
      data.buy_candidates.forEach((stock) => {
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>${stock.ìµœì¢…ìˆœìœ„ || "-"}</td>
                <td>${stock.ì¢…ëª©ëª… || "-"}</td>
                <td>${stock.ì¢…ëª©ì½”ë“œ || "-"}</td>
                <td>${
                  stock.í˜„ì¬ê°€ ? stock.í˜„ì¬ê°€.toLocaleString() + "ì›" : "-"
                }</td>
                <td>${
                  stock.final_score ? stock.final_score.toFixed(2) : "-"
                }</td>
                <td>${
                  stock.ml_pred_proba
                    ? (stock.ml_pred_proba * 100).toFixed(1) + "%"
                    : "-"
                }</td>
            `;
        buyCandidatesTbody.appendChild(row);
      });
    } else {
      buyCandidatesTbody.innerHTML =
        '<tr><td colspan="6" class="text-center text-muted">ë§¤ìˆ˜ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }

  }

  // ë§¤ìˆ˜ ëŒ€ìƒìœ¼ë¡œ ë§¤ë§¤ ì‹¤í–‰
  document
    .getElementById("execute-with-candidates")
    .addEventListener("click", function () {
      if (
        !window.currentAnalysisResult ||
        !window.currentAnalysisResult.analysis_result
      ) {
        console.error("ë¶„ì„ ê²°ê³¼ ì—†ìŒ:", window.currentAnalysisResult);
        showAlert("ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.", "warning");
        return;
      }

      const button = this;
      const originalText = button.innerHTML;

      button.disabled = true;
      button.innerHTML =
        '<i class="fas fa-spinner fa-spin me-1"></i>ì‹¤í–‰ ì¤‘...';

      fetch("/api/auto-trading/execute-with-candidates", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          analysis_result: window.currentAnalysisResult.analysis_result,
          manual_execution: true,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("ìë™ë§¤ë§¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            updateAutoTradingStatus();
            loadExecutionHistory();
            startProgressMonitoring();

            // ëª¨ë‹¬ ë‹«ê¸°
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("analysisResultModal")
            );
            modal.hide();
          } else {
            showAlert(
              data.message || "ìë™ë§¤ë§¤ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
              "danger"
            );
          }
        })
        .catch((error) => {
          console.error("ë§¤ë§¤ ì‹¤í–‰ ì‹¤íŒ¨:", error);
          showAlert("ìë™ë§¤ë§¤ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "danger");
        })
        .finally(() => {
          button.disabled = false;
          button.innerHTML = originalText;
        });
    });

  // ìˆ˜ë™ ì‹¤í–‰
  document
    .getElementById("manual-execute-btn")
    .addEventListener("click", function () {
      const modal = new bootstrap.Modal(
        document.getElementById("manualExecuteModal")
      );
      modal.show();
    });

  document
    .getElementById("confirm-manual-execute")
    .addEventListener("click", function () {
      fetch("/api/auto-trading/execute", {
        method: "POST",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("ìë™ë§¤ë§¤ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            loadExecutionHistory();
            updateAutoTradingStatus();
          } else {
            showAlert(
              data.message || "ìë™ë§¤ë§¤ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
              "danger"
            );
          }
        })
        .catch((error) => {
          console.error("ìˆ˜ë™ ì‹¤í–‰ ì‹¤íŒ¨:", error);
          showAlert("ìë™ë§¤ë§¤ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "danger");
        });

      const modal = bootstrap.Modal.getInstance(
        document.getElementById("manualExecuteModal")
      );
      modal.hide();

      // ì‹¤í–‰ ì‹œì‘ í›„ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
      startProgressMonitoring();
    });

  // ê¸´ê¸‰ ì¤‘ì§€
  document
    .getElementById("emergency-stop-btn")
    .addEventListener("click", function () {
      const modal = new bootstrap.Modal(
        document.getElementById("emergencyStopModal")
      );
      modal.show();
    });

  document
    .getElementById("confirm-emergency-stop")
    .addEventListener("click", function () {
      fetch("/api/auto-trading/stop", {
        method: "POST",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("ìë™ë§¤ë§¤ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.", "warning");
            updateAutoTradingStatus();
          } else {
            showAlert(
              data.message || "ìë™ë§¤ë§¤ ì¤‘ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
              "danger"
            );
          }
        })
        .catch((error) => {
          console.error("ê¸´ê¸‰ ì¤‘ì§€ ì‹¤íŒ¨:", error);
          showAlert("ìë™ë§¤ë§¤ ì¤‘ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "danger");
        });

      const modal = bootstrap.Modal.getInstance(
        document.getElementById("emergencyStopModal")
      );
      modal.hide();
    });
</script>

<style>
/* í•«í•‘í¬ ë°°ì§€ ìƒ‰ìƒ */
.bg-hotpink {
    background-color: #ff69b4 !important;
}
</style>
{% endblock %}
