{% extends "base.html" %} {% block title %}포트폴리오 - 키움 자동매매{% endblock
%} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-briefcase me-2"></i>포트폴리오 분석</h2>
      <div>
        <button
          class="btn btn-outline-primary me-2"
          onclick="refreshPortfolio()"
        >
          <i class="fas fa-sync-alt"></i> 새로고침
        </button>
        <button class="btn btn-primary" onclick="exportPortfolio()">
          <i class="fas fa-download"></i> 내보내기
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 포트폴리오 요약 카드 -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">총 매수금액</h6>
            <h4 class="mb-0" id="total-purchase">-</h4>
          </div>
          <div class="align-self-center">
            <i class="fas fa-chart-pie fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-success text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">총 평가금액</h6>
            <h4 class="mb-0" id="total-value">-</h4>
          </div>
          <div class="align-self-center">
            <i class="fas fa-won-sign fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-info text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">총 손익금액</h6>
            <h4 class="mb-0" id="total-profit">-</h4>
          </div>
          <div class="align-self-center">
            <i class="fas fa-chart-line fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">평균 수익률</h6>
            <h4 class="mb-0" id="avg-return">-</h4>
          </div>
          <div class="align-self-center">
            <i class="fas fa-percentage fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- 보유 종목 상세 테이블 -->
  <div class="col-lg-8 mb-4">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0"><i class="fas fa-list me-2"></i>보유 종목 상세</h5>
        <div class="d-flex gap-2">
          <select
            class="form-select form-select-sm"
            id="sort-by"
            onchange="sortPortfolio()"
          >
            <option value="name">종목명</option>
            <option value="value">평가금액</option>
            <option value="profit">손익금액</option>
            <option value="return">수익률</option>
          </select>
          <input
            type="text"
            class="form-control form-control-sm"
            id="search-stock"
            placeholder="종목 검색..."
            onkeyup="searchStocks()"
          />
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="portfolio-table">
            <thead>
              <tr>
                <th>종목명</th>
                <th>보유수량</th>
                <th>평균단가</th>
                <th>현재가</th>
                <th>평가금액</th>
                <th>손익금액</th>
                <th>수익률</th>
                <th>비중</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="portfolio-tbody">
              <tr>
                <td colspan="9" class="text-center text-muted">
                  데이터를 불러오는 중...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 포트폴리오 구성 차트 -->
  <div class="col-lg-4 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-chart-pie me-2"></i>포트폴리오 구성
        </h5>
      </div>
      <div class="card-body">
        <div id="portfolio-chart" style="width: 100%; height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>

<!-- 수익률 차트 -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">
          <i class="fas fa-chart-line me-2"></i>종목별 수익률
        </h5>
        <div>
          <button
            class="btn btn-sm btn-outline-primary"
            onclick="toggleChartView()"
          >
            <i class="fas fa-chart-bar"></i> 막대 차트
          </button>
        </div>
      </div>
      <div class="card-body">
        <div id="return-chart" style="width: 100%; height: 300px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>

<!-- 종목 상세 모달 -->
<div class="modal fade" id="stockDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stockDetailTitle">종목 상세 정보</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="stockDetailBody">
        <!-- 종목 상세 정보가 여기에 표시됩니다 -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          닫기
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="viewStockChart()"
        >
          차트 보기
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 차트 모달 -->
<div class="modal fade" id="chartModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chartModalTitle">종목 차트</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <!-- 차트 컨트롤 -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label for="chartType" class="form-label">차트 타입</label>
            <select class="form-select" id="chartType" onchange="changeChartType()">
              <option value="daily">일봉</option>
              <option value="weekly">주봉</option>
              <option value="monthly">월봉</option>
              <option value="yearly">년봉</option>
              <option value="minute">분봉</option>
              <option value="tick">틱차트</option>
            </select>
          </div>
          <div class="col-md-3" id="timeFrameContainer" style="display: none;">
            <label for="timeFrame" class="form-label">시간 단위</label>
            <select class="form-select" id="timeFrame" onchange="loadChart()">
              <option value="1">1분</option>
              <option value="3">3분</option>
              <option value="5">5분</option>
              <option value="10">10분</option>
              <option value="15">15분</option>
              <option value="30">30분</option>
              <option value="45">45분</option>
              <option value="60">60분</option>
            </select>
          </div>
          <div class="col-md-3" id="tickScopeContainer" style="display: none;">
            <label for="tickScope" class="form-label">틱 범위</label>
            <select class="form-select" id="tickScope" onchange="loadChart()">
              <option value="1">1틱</option>
              <option value="3">3틱</option>
              <option value="5">5틱</option>
              <option value="10">10틱</option>
              <option value="30">30틱</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="chartPeriod" class="form-label">기간</label>
            <select class="form-select" id="chartPeriod" onchange="loadChart()">
              <option value="30">최근 30일</option>
              <option value="90">최근 3개월</option>
              <option value="180">최근 6개월</option>
              <option value="365">최근 1년</option>
              <option value="all">전체</option>
            </select>
          </div>
        </div>
        
        <!-- 차트 영역 -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="card-title mb-0" id="chartTitle">차트 로딩 중...</h6>
                          <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary active" id="candlestickBtn" onclick="toggleChartView('candlestick')">
                              <i class="fas fa-chart-line"></i> 캔들
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="lineBtn" onclick="toggleChartView('line')">
                              <i class="fas fa-chart-area"></i> 라인
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="volumeBtn" onclick="toggleChartView('volume')">
                              <i class="fas fa-chart-bar"></i> 거래량
                            </button>
                          </div>
                </div>
                <div style="position: relative; height: 500px;">
                  <div id="stockChart" style="width: 100%; height: 500px;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 투자자별 차트 (일봉일 때만 표시) -->
        <div class="row mt-3" id="investorChartContainer" style="display: none;">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">투자자별 매매 동향</h6>
              </div>
                      <div class="card-body">
                        <div style="position: relative; height: 300px;">
                          <div id="investorChart" style="width: 100%; height: 100%;"></div>
                        </div>
                      </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          닫기
        </button>
        <button type="button" class="btn btn-primary" onclick="refreshChart()">
          <i class="fas fa-sync-alt"></i> 새로고침
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<style>
  /* 포트폴리오 요약 카드 높이 통일 */
  .row.mb-4 .card {
    height: 85px;
    display: flex;
    flex-direction: column;
  }

  .row.mb-4 .card-body {
    flex: 1;
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
  }

  /* 동적 색상 클래스가 높이에 영향을 주지 않도록 */
  .row.mb-4 .card-body h4 {
    margin-bottom: 0;
    line-height: 1.2;
    font-size: 1.4rem;
    font-weight: 600;
  }

  /* 아이콘을 오른쪽 끝으로 배치 */
  .row.mb-4 .card-body .d-flex {
    width: 100%;
    justify-content: space-between;
  }

  .row.mb-4 .card-body .align-self-center {
    align-self: center !important;
    margin-left: auto;
  }
</style>
<script>
  // 포트폴리오 전용 JavaScript
  let portfolioData = [];
  let portfolioChart = null;
  let returnChart = null;
  let isBarChart = false;

  document.addEventListener("DOMContentLoaded", function () {
    // 서버 정보 즉시 업데이트
    updateServerInfoFromTemplate();

    loadPortfolio();

    // 60초마다 자동 새로고침
    setInterval(loadPortfolio, 60000);
  });

  function updateServerInfoFromTemplate() {
    // 템플릿에서 전달받은 서버 정보로 즉시 업데이트
    {% if server_info %}
    const serverNameElement = document.getElementById('server-name');
    const serverInfoElement = document.getElementById('server-info');

    if (serverNameElement && serverInfoElement) {
      serverNameElement.textContent = '{{ server_info.server_name }}';

      // 서버별 색상 적용
      if ('{{ server_info.server_type }}' === 'mock') {
        serverInfoElement.style.color = '#4CAF50';
      } else {
        serverInfoElement.style.color = '#F44336';
      }
    }
    {% endif %}
  }

  function loadPortfolio() {
    fetch("/api/account/evaluation")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.data.stk_acnt_evlt_prst) {
          portfolioData = data.data.stk_acnt_evlt_prst;
          updatePortfolioSummary(data.data);
          updatePortfolioTable(portfolioData);
          updatePortfolioChart(portfolioData);
          updateReturnChart(portfolioData);
        } else if (data.authenticated === false) {
          isAuthenticated = false;
          updateAuthUI(false);
          showAlert("세션이 만료되었습니다. 다시 로그인해주세요.", "warning");
          return;
        } else {
          document.getElementById("portfolio-tbody").innerHTML =
            '<tr><td colspan="9" class="text-center text-muted">보유 종목이 없습니다.</td></tr>';
        }
      })
      .catch((error) => {
        console.error("포트폴리오 조회 실패:", error);
        document.getElementById("portfolio-tbody").innerHTML =
          '<tr><td colspan="9" class="text-center text-danger">데이터 조회 실패</td></tr>';
      });
  }

  function updatePortfolioSummary(data) {
    // kt00018 API 응답 필드 사용
    const totalPurchase = parseFloat(data.tot_pur_amt || "0");
    const totalValue = parseFloat(data.tot_evlt_amt || "0");
    const totalProfit = parseFloat(data.tot_evlt_pl || "0");
    const avgReturn = parseFloat(data.tot_prft_rt || "0");

    // 총 매수금액 표시
    document.getElementById("total-purchase").textContent =
      formatNumber(totalPurchase) + "원";

    // 총 평가금액 표시 및 색상 설정 (전체 수익중일 때 빨간색)
    const valueElement = document.getElementById("total-value");
    valueElement.textContent = formatNumber(totalValue) + "원";
    if (totalProfit > 0) {
      valueElement.className = "text-up"; // 수익중일 때 빨간색
    } else {
      valueElement.className = "text-white"; // 기본 흰색
    }

    // 총 손익금액 표시 (양수일 때 + 기호 추가)
    const formattedProfit = totalProfit > 0 
      ? "+" + formatNumber(totalProfit) + "원"
      : formatNumber(totalProfit) + "원";
    document.getElementById("total-profit").textContent = formattedProfit;

    // 평균 수익률 표시 (양수일 때 + 기호 추가)
    const formattedReturn = avgReturn > 0 
      ? "+" + avgReturn.toFixed(2) + "%"
      : avgReturn.toFixed(2) + "%";
    document.getElementById("avg-return").textContent = formattedReturn;

    // 손익에 따른 색상 설정 (한국 주식 시장 관례: 상승=빨간색, 하락=파란색)
    const profitElement = document.getElementById("total-profit");
    const returnElement = document.getElementById("avg-return");

    if (totalProfit > 0) {
      profitElement.className = "text-up"; // 상승: 빨간색
      returnElement.className = "text-up"; // 상승: 빨간색
    } else if (totalProfit < 0) {
      profitElement.className = "text-down"; // 하락: 파란색
      returnElement.className = "text-down"; // 하락: 파란색
    } else {
      profitElement.className = "text-neutral"; // 보합: 회색
      returnElement.className = "text-neutral"; // 보합: 회색
    }
  }

  function updatePortfolioTable(stocks) {
    const tbody = document.getElementById("portfolio-tbody");
    tbody.innerHTML = "";

    const totalValue = stocks.reduce(
      (sum, stock) => sum + parseFloat(stock.evlt_amt || "0"),
      0
    );

    stocks.forEach((stock) => {
      const row = document.createElement("tr");
      const profit = parseFloat(stock.pl_amt || "0");
      const returnRate = parseFloat(stock.pl_rt || "0");
      const value = parseFloat(stock.evlt_amt || "0");
      const weight =
        totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : "0.0";

      row.innerHTML = `
            <td>
                <strong>${stock.stk_nm || "-"}</strong>
                <br><small class="text-muted">${stock.stk_cd || ""}</small>
            </td>
            <td>${formatNumber(stock.rmnd_qty || "0")}</td>
            <td>${formatNumber(stock.avg_prc || "0")}원</td>
            <td>${formatNumber(stock.cur_prc || "0")}원</td>
            <td>${formatNumber(stock.evlt_amt || "0")}원</td>
            <td class="${profit >= 0 ? "text-up" : "text-down"}">
                ${formatNumber(stock.pl_amt || "0")}원
            </td>
            <td class="${returnRate >= 0 ? "text-up" : "text-down"}">
                ${parseFloat(stock.pl_rt || "0").toFixed(2)}%
            </td>
            <td>${weight}%</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showStockDetail('${
                  stock.stk_cd
                }', '${stock.stk_nm}')">
                    <i class="fas fa-info-circle"></i>
                </button>
            </td>
        `;
      tbody.appendChild(row);
    });
  }

  function updatePortfolioChart(stocks) {
    const chartContainer = document.getElementById("portfolio-chart");

    if (portfolioChart) {
      portfolioChart.remove();
    }

    const labels = stocks.map((stock) => stock.stk_nm || "Unknown");
    const data = stocks.map((stock) => parseFloat(stock.evlt_amt || "0"));
    const colors = generateColors(stocks.length);

    // 간단한 HTML 기반 차트로 대체
    const total = data.reduce((a, b) => a + b, 0);
    
    let chartHTML = '<div class="portfolio-chart-container">';
    stocks.forEach((stock, index) => {
      const value = parseFloat(stock.evlt_amt || "0");
      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
      
      chartHTML += `
        <div class="portfolio-chart-item" style="margin-bottom: 10px;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="chart-color-indicator" style="width: 12px; height: 12px; background-color: ${colors[index]}; border-radius: 50%; margin-right: 8px;"></div>
              <span class="stock-name">${stock.stk_nm || "Unknown"}</span>
            </div>
            <div class="text-end">
              <div class="stock-value">${formatNumber(value)}원</div>
              <div class="stock-percentage text-muted small">${percentage}%</div>
            </div>
          </div>
          <div class="progress mt-1" style="height: 4px;">
            <div class="progress-bar" style="width: ${percentage}%; background-color: ${colors[index]};"></div>
          </div>
        </div>
      `;
    });
    chartHTML += '</div>';
    
    chartContainer.innerHTML = chartHTML;
  }

  function updateReturnChart(stocks) {
    const chartContainer = document.getElementById("return-chart");

    if (returnChart) {
      returnChart.remove();
    }

    const labels = stocks.map((stock) => stock.stk_nm || "Unknown");
    const data = stocks.map((stock) => parseFloat(stock.pl_rt || "0"));
    const colors = data.map((value) => (value >= 0 ? "#28a745" : "#dc3545"));

    // 간단한 HTML 기반 차트로 대체
    let chartHTML = '<div class="return-chart-container">';
    stocks.forEach((stock, index) => {
      const returnRate = parseFloat(stock.pl_rt || "0");
      const color = returnRate >= 0 ? "#28a745" : "#dc3545";
      const icon = returnRate >= 0 ? "fa-arrow-up" : "fa-arrow-down";
      
      chartHTML += `
        <div class="return-chart-item" style="margin-bottom: 8px;">
          <div class="d-flex justify-content-between align-items-center">
            <span class="stock-name">${stock.stk_nm || "Unknown"}</span>
            <div class="d-flex align-items-center">
              <i class="fas ${icon} me-1" style="color: ${color};"></i>
              <span class="return-rate" style="color: ${color}; font-weight: bold;">
                ${returnRate >= 0 ? '+' : ''}${returnRate.toFixed(2)}%
              </span>
            </div>
          </div>
          <div class="progress mt-1" style="height: 3px;">
            <div class="progress-bar" style="width: ${Math.min(Math.abs(returnRate) * 2, 100)}%; background-color: ${color};"></div>
          </div>
        </div>
      `;
    });
    chartHTML += '</div>';
    
    chartContainer.innerHTML = chartHTML;
  }

  function generateColors(count) {
    const colors = [];
    const hueStep = 360 / count;

    for (let i = 0; i < count; i++) {
      const hue = i * hueStep;
      colors.push(`hsl(${hue}, 70%, 60%)`);
    }

    return colors;
  }

  function sortPortfolio() {
    const sortBy = document.getElementById("sort-by").value;

    portfolioData.sort((a, b) => {
      switch (sortBy) {
        case "name":
          return (a.stk_nm || "").localeCompare(b.stk_nm || "");
        case "value":
          return parseFloat(b.evlt_amt || "0") - parseFloat(a.evlt_amt || "0");
        case "profit":
          return parseFloat(b.pl_amt || "0") - parseFloat(a.pl_amt || "0");
        case "return":
          return parseFloat(b.pl_rt || "0") - parseFloat(a.pl_rt || "0");
        default:
          return 0;
      }
    });

    updatePortfolioTable(portfolioData);
  }

  function searchStocks() {
    const searchTerm = document
      .getElementById("search-stock")
      .value.toLowerCase();
    const filteredData = portfolioData.filter(
      (stock) =>
        (stock.stk_nm || "").toLowerCase().includes(searchTerm) ||
        (stock.stk_cd || "").toLowerCase().includes(searchTerm)
    );

    updatePortfolioTable(filteredData);
  }

  function showStockDetail(stockCode, stockName) {
    document.getElementById("stockDetailTitle").innerHTML =
      '<span class="text-black fw-bold">' + stockName + " (" + stockCode + ")" + '</span>';

    // 로딩 표시
    document.getElementById("stockDetailBody").innerHTML = `
      <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">로딩 중...</span>
        </div>
        <p class="mt-2 text-muted">종목 정보를 불러오는 중...</p>
      </div>
    `;

    // 종목 상세 정보 로드
    fetch(`/api/quote/stock/${stockCode}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const stockInfo = data.data;
          // 숫자 파싱 함수 (+, - 기호 제거)
          function parseNumber(value) {
            if (!value || value === '') return '0';
            return value.toString().replace(/[+\-]/g, '');
          }
          
          // 금액 포맷팅 함수 (단위 변환)
          function formatAmount(value, unit = '원', unitType = 'normal') {
            const num = parseNumber(value);
            const amount = parseInt(num);
            
            if (unitType === 'capital') {
              // 자본금, 영업이익, 당기순이익: 억원 단위 (API에서 억원으로 제공)
              if (amount >= 10000) {
                return (amount / 10000).toFixed(0) + '억' + unit;
              } else {
                return formatNumber(num) + '억' + unit;
              }
            } else if (unitType === 'revenue') {
              // 매출액, 시가총액: 만원 단위 (API에서 만원으로 제공)
              if (amount >= 100000000) {
                return (amount / 100000000).toFixed(1) + '조' + unit;
              } else if (amount >= 10000) {
                return (amount / 10000).toFixed(1) + '억' + unit;
              } else {
                return formatNumber(num) + '만' + unit;
              }
            } else {
              // 일반 금액 (주가 등)
              if (amount >= 100000000) {
                return (amount / 100000000).toFixed(1) + '억' + unit;
              } else if (amount >= 10000) {
                return (amount / 10000).toFixed(1) + '만' + unit;
              } else {
                return formatNumber(num) + unit;
              }
            }
          }
          
          // 주식 수량 포맷팅 함수
          function formatStockQuantity(value) {
            const num = parseNumber(value);
            const amount = parseInt(num);
            if (amount >= 100000000) {
              return (amount / 100000000).toFixed(1) + '억주';
            } else if (amount >= 10000) {
              return (amount / 10000).toFixed(1) + '만주';
            } else {
              return formatNumber(num) + '주';
            }
          }
          
          document.getElementById("stockDetailBody").innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-black fw-bold mb-3">기본 정보</h6>
                            <table class="table table-sm table-striped">
                                <tr><td class="fw-semibold text-black">종목명</td><td class="text-black">${stockInfo.stk_nm || stockName}</td></tr>
                                <tr><td class="fw-semibold text-black">종목코드</td><td class="text-black">${stockInfo.stk_cd || stockCode}</td></tr>
                                <tr><td class="fw-semibold text-black">액면가</td><td class="text-black">${formatAmount(stockInfo.fav)}</td></tr>
                                <tr><td class="fw-semibold text-black">자본금</td><td class="text-black">${formatAmount(stockInfo.cap, '원', 'capital')}</td></tr>
                                <tr><td class="fw-semibold text-black">상장주식</td><td class="text-black">${formatStockQuantity(stockInfo.flo_stk)}</td></tr>
                                <tr><td class="fw-semibold text-black">신용비율</td><td class="text-black">${stockInfo.crd_rt || "0"}%</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-black fw-bold mb-3">시세 정보</h6>
                            <table class="table table-sm table-striped">
                                <tr><td class="fw-semibold text-black">연중최고</td><td class="text-black">${formatAmount(stockInfo.oyr_hgst)}</td></tr>
                                <tr><td class="fw-semibold text-black">연중최저</td><td class="text-black">${formatAmount(stockInfo.oyr_lwst)}</td></tr>
                                <tr><td class="fw-semibold text-black">시가총액</td><td class="text-black">${formatAmount(stockInfo.mac, '원', 'revenue')}</td></tr>
                                <tr><td class="fw-semibold text-black">시가총액비중</td><td class="text-black">${stockInfo.mac_wght || "0"}%</td></tr>
                                <tr><td class="fw-semibold text-black">외인소진률</td><td class="text-black">${stockInfo.for_exh_rt || "0"}%</td></tr>
                                <tr><td class="fw-semibold text-black">대용가</td><td class="text-black">${formatAmount(stockInfo.repl_pric)}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-black fw-bold mb-3">투자지표</h6>
                            <table class="table table-sm table-striped">
                                <tr><td class="fw-semibold text-black">PER</td><td class="text-black">${stockInfo.per || "-"}</td></tr>
                                <tr><td class="fw-semibold text-black">EPS</td><td class="text-black">${formatAmount(stockInfo.eps)}</td></tr>
                                <tr><td class="fw-semibold text-black">ROE</td><td class="text-black">${stockInfo.roe || "0"}%</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-black fw-bold mb-3">현재 시세</h6>
                            <table class="table table-sm table-striped">
                                <tr><td class="fw-semibold text-black">현재가</td><td class="text-black">${formatAmount(stockInfo.cur_prc)}</td></tr>
                                <tr><td class="fw-semibold text-black">시가</td><td class="text-black">${formatAmount(stockInfo.open_pric)}</td></tr>
                                <tr><td class="fw-semibold text-black">고가</td><td class="text-black">${formatAmount(stockInfo.high_pric)}</td></tr>
                                <tr><td class="fw-semibold text-black">저가</td><td class="text-black">${formatAmount(stockInfo.low_pric)}</td></tr>
                                <tr><td class="fw-semibold text-black">거래량</td><td class="text-black">${formatStockQuantity(stockInfo.trde_qty)}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-black fw-bold mb-3">기타 정보</h6>
                            <table class="table table-sm table-striped">
                                <tr><td class="fw-semibold text-black">결산월</td><td class="text-black">${stockInfo.setl_mm || "-"}월</td></tr>
                                <tr><td class="fw-semibold text-black">PBR</td><td class="text-black">${stockInfo.pbr || "-"}</td></tr>
                                <tr><td class="fw-semibold text-black">BPS</td><td class="text-black">${formatAmount(stockInfo.bps)}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-black fw-bold mb-3">재무 정보</h6>
                            <table class="table table-sm table-striped">
                                <tr><td class="fw-semibold text-black">매출액</td><td class="text-black">${formatAmount(stockInfo.sale_amt, '원', 'revenue')}</td></tr>
                                <tr><td class="fw-semibold text-black">영업이익</td><td class="text-black">${formatAmount(stockInfo.bus_pro, '원', 'capital')}</td></tr>
                                <tr><td class="fw-semibold text-black">당기순이익</td><td class="text-black">${formatAmount(stockInfo.cup_nga, '원', 'capital')}</td></tr>
                            </table>
                        </div>
                    </div>
                `;
        } else {
          document.getElementById("stockDetailBody").innerHTML =
            '<p class="text-muted">종목 정보를 불러올 수 없습니다.</p>';
        }
      })
      .catch((error) => {
        console.error("종목 정보 조회 실패:", error);
        document.getElementById("stockDetailBody").innerHTML =
          '<p class="text-danger">종목 정보 조회에 실패했습니다.</p>';
      });

    new bootstrap.Modal(document.getElementById("stockDetailModal")).show();
  }

  function toggleChartView() {
    isBarChart = !isBarChart;
    updateReturnChart(portfolioData);

    const button = event.target.closest("button");
    button.innerHTML = isBarChart
      ? '<i class="fas fa-chart-line"></i> 선 차트'
      : '<i class="fas fa-chart-bar"></i> 막대 차트';
  }

  function refreshPortfolio() {
    loadPortfolio();
    showAlert("포트폴리오가 새로고침되었습니다.", "success");
  }

  function exportPortfolio() {
    // CSV 내보내기 기능
    const csvContent = generateCSV(portfolioData);
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);

    link.setAttribute("href", url);
    link.setAttribute(
      "download",
      "portfolio_" + new Date().toISOString().split("T")[0] + ".csv"
    );
    link.style.visibility = "hidden";

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showAlert("포트폴리오가 내보내기되었습니다.", "success");
  }

  function generateCSV(data) {
    const headers = [
      "종목명",
      "종목코드",
      "보유수량",
      "평균단가",
      "현재가",
      "평가금액",
      "손익금액",
      "수익률",
    ];
    const rows = data.map((stock) => [
      stock.stk_nm || "",
      stock.stk_cd || "",
      stock.rmnd_qty || "0",
      stock.avg_prc || "0",
      stock.cur_prc || "0",
      stock.evlt_amt || "0",
      stock.pl_amt || "0",
      stock.pl_rt || "0",
    ]);

    return [headers, ...rows].map((row) => row.join(",")).join("\n");
  }

  // 차트 관련 전역 변수
  let currentStockCode = '';
  let currentStockName = '';
  let stockChart = null;
  let investorChart = null;
  let currentChartView = 'candlestick';

  function viewStockChart() {
    // 현재 선택된 종목 정보 가져오기
    const modalTitle = document.getElementById('stockDetailTitle').textContent;
    const match = modalTitle.match(/(.+?)\s*\((.+?)\)/);
    
    if (match) {
      currentStockName = match[1].trim();
      currentStockCode = match[2].trim();
      
      // 차트 모달 제목 설정
      document.getElementById('chartModalTitle').textContent = `${currentStockName} (${currentStockCode}) 차트`;
      
      // 차트 모달 표시
      new bootstrap.Modal(document.getElementById('chartModal')).show();
      
      // 차트 로드
      loadChart();
    } else {
      showAlert("종목 정보를 가져올 수 없습니다.", "error");
    }
  }

  function changeChartType() {
    const chartType = document.getElementById('chartType').value;
    const timeFrameContainer = document.getElementById('timeFrameContainer');
    const tickScopeContainer = document.getElementById('tickScopeContainer');
    const investorChartContainer = document.getElementById('investorChartContainer');
    
    // 컨트롤 표시/숨김
    if (chartType === 'minute') {
      timeFrameContainer.style.display = 'block';
      tickScopeContainer.style.display = 'none';
    } else if (chartType === 'tick') {
      timeFrameContainer.style.display = 'none';
      tickScopeContainer.style.display = 'block';
    } else {
      timeFrameContainer.style.display = 'none';
      tickScopeContainer.style.display = 'none';
    }
    
    // 투자자별 차트는 일봉일 때만 표시
    if (chartType === 'daily') {
      investorChartContainer.style.display = 'block';
    } else {
      investorChartContainer.style.display = 'none';
    }
    
    // 차트 다시 로드
    loadChart();
  }

  function loadChart() {
    if (!currentStockCode) return;
    
    const chartType = document.getElementById('chartType').value;
    const chartTitle = document.getElementById('chartTitle');
    
    // 차트 제목 설정
    chartTitle.textContent = `${currentStockName} - ${getChartTypeName(chartType)}`;
    
    // 로딩 표시
    showChartLoading();
    
    // 차트 타입에 따른 API 호출
    let apiEndpoint = '';
    let requestData = {
      stock_code: currentStockCode
    };
    
    // 키움 API는 base_dt부터 과거 데이터를 가져오므로 항상 오늘 날짜로 요청
    // 기간 필터링은 프론트엔드에서 처리
    const today = new Date();
    const baseDate = today.toISOString().slice(0, 10).replace(/-/g, '');
    
    switch (chartType) {
      case 'daily':
        apiEndpoint = '/api/chart/daily';
        requestData.base_dt = baseDate;
        break;
      case 'weekly':
        apiEndpoint = '/api/chart/weekly';
        requestData.base_dt = baseDate;
        break;
      case 'monthly':
        apiEndpoint = '/api/chart/monthly';
        requestData.base_dt = baseDate;
        break;
      case 'yearly':
        apiEndpoint = '/api/chart/yearly';
        requestData.base_dt = baseDate;
        break;
      case 'minute':
        apiEndpoint = '/api/chart/minute';
        requestData.tick_scope = document.getElementById('timeFrame').value;
        break;
      case 'tick':
        apiEndpoint = '/api/chart/tick';
        requestData.tick_scope = document.getElementById('tickScope').value;
        break;
    }
    
    // 차트 데이터 요청
    fetch(apiEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // 기간에 따른 데이터 필터링
        const filteredData = filterChartDataByPeriod(data.data, chartType);
        renderChart(filteredData, chartType);
        
        // 일봉일 때만 투자자별 차트도 로드
        if (chartType === 'daily') {
          loadInvestorChart();
        } else {
          // 다른 차트 타입일 때는 투자자별 차트 숨기기
          const investorContainer = document.getElementById('investorChartContainer');
          if (investorContainer) {
            investorContainer.style.display = 'none';
          }
        }
      } else {
        showChartError(data.message || '차트 데이터를 불러올 수 없습니다.');
      }
    })
    .catch(error => {
      console.error('차트 로드 실패:', error);
      showChartError('차트 데이터를 불러오는 중 오류가 발생했습니다.');
    });
  }

  function loadInvestorChart() {
    if (!currentStockCode) return;
    
    // 투자자별 데이터 요청 (최근 30일 데이터)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    const dateStr = thirtyDaysAgo.toISOString().slice(0, 10).replace(/-/g, '');
    
    fetch('/api/chart/investor', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        stock_code: currentStockCode,
        dt: dateStr,
        amt_qty_tp: '1', // 금액
        trde_tp: '0',    // 순매수
        unit_tp: '1000'  // 천주
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.data && data.data.stk_invsr_orgn_chart) {
        const chartData = data.data.stk_invsr_orgn_chart;
        if (chartData.length > 0) {
          renderInvestorChart(data.data);
          // 투자자별 차트 컨테이너 표시
          const investorContainer = document.getElementById('investorChartContainer');
          if (investorContainer) {
            investorContainer.style.display = 'block';
          }
        } else {
          console.log('투자자별 차트 데이터가 없습니다.');
          // 투자자별 차트 컨테이너 숨기기
          const investorContainer = document.getElementById('investorChartContainer');
          if (investorContainer) {
            investorContainer.style.display = 'none';
          }
        }
      } else {
        console.log('투자자별 차트 API 응답이 비어있습니다.');
        // 투자자별 차트 컨테이너 숨기기
        const investorContainer = document.getElementById('investorChartContainer');
        if (investorContainer) {
          investorContainer.style.display = 'none';
        }
      }
    })
    .catch(error => {
      console.error('투자자별 차트 로드 실패:', error);
      // 투자자별 차트 컨테이너 숨기기
      const investorContainer = document.getElementById('investorChartContainer');
      if (investorContainer) {
        investorContainer.style.display = 'none';
      }
    });
  }

  function renderChart(chartData, chartType) {
    const chartContainer = document.getElementById('stockChart');
    
    // 기존 차트 제거
    if (stockChart) {
      stockChart.remove();
      stockChart = null;
    }
    
    // 컨테이너 초기화
    chartContainer.innerHTML = '';
    
    // 차트 타입에 따른 데이터 필드 선택
    let dataField = '';
    switch (chartType) {
      case 'daily':
        dataField = 'stk_dt_pole_chart_qry';
        break;
      case 'weekly':
        dataField = 'stk_stk_pole_chart_qry';
        break;
      case 'monthly':
        dataField = 'stk_mth_pole_chart_qry';
        break;
      case 'yearly':
        dataField = 'stk_yr_pole_chart_qry';
        break;
      case 'minute':
        dataField = 'stk_min_pole_chart_qry';
        break;
      case 'tick':
        dataField = 'stk_tic_chart_qry';
        break;
    }
    
    const rawData = chartData[dataField] || [];
    
    // 데이터 가공
    const candlestickData = [];
    const volumeData = [];
    const lineData = [];
    
    rawData.forEach(item => {
      try {
        const open = parseFloat(item.open_pric || 0);
        const high = parseFloat(item.high_pric || 0);
        const low = parseFloat(item.low_pric || 0);
        const close = parseFloat(item.cur_prc || 0);
        const volume = parseFloat(item.trde_qty || 0);
        
        // 차트 타입에 따라 날짜 필드 선택
        let date = '';
        if (chartType === 'minute' || chartType === 'tick') {
          date = item.cntr_tm || '';
        } else {
          date = item.dt || '';
        }
        
        if (close > 0 && date && date.length >= 8) {
          // 시간을 Unix timestamp로 변환
          let timestamp;
          if (date.length === 14) { // YYYYMMDDHHMMSS
            const year = parseInt(date.substring(0, 4));
            const month = parseInt(date.substring(4, 6)) - 1;
            const day = parseInt(date.substring(6, 8));
            const hour = parseInt(date.substring(8, 10));
            const minute = parseInt(date.substring(10, 12));
            const second = parseInt(date.substring(12, 14));
            timestamp = Math.floor(new Date(year, month, day, hour, minute, second).getTime() / 1000);
          } else if (date.length === 8) { // YYYYMMDD
            const year = parseInt(date.substring(0, 4));
            const month = parseInt(date.substring(4, 6)) - 1;
            const day = parseInt(date.substring(6, 8));
            timestamp = Math.floor(new Date(year, month, day).getTime() / 1000);
          }
          
          if (timestamp && !isNaN(timestamp)) {
            candlestickData.push({
              time: timestamp,
              open: open,
              high: high,
              low: low,
              close: close
            });
            
            volumeData.push({
              time: timestamp,
              value: volume,
              color: close >= open ? '#26a69a' : '#ef5350'
            });
            
            lineData.push({
              time: timestamp,
              value: close
            });
          }
        }
      } catch (error) {
        console.warn('차트 데이터 파싱 실패:', error, item);
      }
    });
    
    // 최근 데이터부터 표시 (역순 정렬)
    candlestickData.reverse();
    volumeData.reverse();
    lineData.reverse();
    
    // 메인 차트 생성
    const containerWidth = chartContainer.clientWidth || 800;
    const containerHeight = Math.max(chartContainer.clientHeight || 400, 300);
    
    const chart = LightweightCharts.createChart(chartContainer, {
      width: containerWidth,
      height: containerHeight,
      layout: {
        backgroundColor: '#ffffff',
        textColor: '#333',
      },
      grid: {
        vertLines: {
          color: '#f0f0f0',
        },
        horzLines: {
          color: '#f0f0f0',
        },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
      rightPriceScale: {
        borderColor: '#cccccc',
      },
      timeScale: {
        borderColor: '#cccccc',
        timeVisible: true,
        secondsVisible: false,
        rightOffset: 0,
        barSpacing: 0,
        lockVisibleTimeRangeOnResize: true,
      },
    });
    
    // 캔들스틱 시리즈 추가
    const candlestickSeries = chart.addCandlestickSeries({
      upColor: '#26a69a',
      downColor: '#ef5350',
      borderDownColor: '#ef5350',
      borderUpColor: '#26a69a',
      wickDownColor: '#ef5350',
      wickUpColor: '#26a69a',
    });
    
    // 라인 시리즈 추가
    const lineSeries = chart.addLineSeries({
      color: '#2196F3',
      lineWidth: 2,
    });
    
    // 거래량 시리즈를 메인 차트에 추가 (하단에 표시)
    const volumeSeries = chart.addHistogramSeries({
      color: '#26a69a',
      priceFormat: {
        type: 'volume',
      },
      priceScaleId: 'volume', // 별도 스케일 사용
    });
    
    // 거래량용 가격 스케일 설정 (겹침 방지를 위해 마진 조정)
    chart.priceScale('volume').applyOptions({
      scaleMargins: {
        top: 0.75, // 상단 75%는 가격 차트용 (더 넓은 공간)
        bottom: 0.05, // 하단 5% 여백 추가
      },
    });
    
    // 메인 가격 스케일도 조정 (겹침 방지)
    chart.priceScale('right').applyOptions({
      scaleMargins: {
        top: 0.1,
        bottom: 0.25, // 하단 25%는 거래량용으로 확보
      },
    });
    
    // 동기화 불필요 - 하나의 차트에 모든 데이터 표시
    
    // 차트 뷰에 따라 데이터 설정 (안전한 처리)
    try {
      if (currentChartView === 'candlestick' && candlestickData.length > 0) {
        candlestickSeries.setData(candlestickData);
        if (volumeData.length > 0) {
          volumeSeries.setData(volumeData);
        }
      } else if (currentChartView === 'line' && lineData.length > 0) {
        lineSeries.setData(lineData);
        if (volumeData.length > 0) {
          volumeSeries.setData(volumeData);
        }
      } else if (currentChartView === 'volume' && volumeData.length > 0) {
        volumeSeries.setData(volumeData);
      } else {
        // 데이터가 없을 때 기본 메시지 표시
        console.warn('차트 데이터가 없습니다.');
      }
    } catch (error) {
      console.error('차트 데이터 설정 실패:', error);
    }
    
    // 차트 리사이즈 처리 (디바운싱 적용)
    let resizeTimeout;
    const handleResize = () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (chart) {
          // 컨테이너의 실제 크기 계산
          const containerRect = chartContainer.getBoundingClientRect();
          const newWidth = Math.max(containerRect.width, 800);
          
          console.log(`차트 리사이즈: ${newWidth}px`);
          
          // 차트 크기 업데이트
          chart.applyOptions({ 
            width: newWidth, 
            height: 500
          });
          
          // 차트 강제 리페인트
          chart.timeScale().fitContent();
        }
      }, 100);
    };
    
    const resizeObserver = new ResizeObserver(handleResize);
    resizeObserver.observe(chartContainer);
    
    // 윈도우 리사이즈 이벤트도 처리
    window.addEventListener('resize', handleResize);
    
    // 초기 로드 시 차트 크기 강제 조정 (해상도 문제 해결)
    setTimeout(() => {
      handleResize();
    }, 100);
    
    // 추가 리사이즈 (더 확실하게)
    setTimeout(() => {
      handleResize();
    }, 300);
    
    // 모달이 완전히 로드된 후 리사이즈
    setTimeout(() => {
      handleResize();
    }, 500);
    
    // 이동평균선 추가 (안전한 처리)
    if (candlestickData.length > 0) {
      try {
        // 5일 이동평균선
        const ma5Data = calculateMovingAverage(candlestickData, 5);
        if (ma5Data.length > 0) {
          const ma5Series = chart.addLineSeries({
            color: '#FF6B6B',
            lineWidth: 1,
            title: 'MA5',
          });
          ma5Series.setData(ma5Data);
        }
        
        // 20일 이동평균선
        const ma20Data = calculateMovingAverage(candlestickData, 20);
        if (ma20Data.length > 0) {
          const ma20Series = chart.addLineSeries({
            color: '#4ECDC4',
            lineWidth: 1,
            title: 'MA20',
          });
          ma20Series.setData(ma20Data);
        }
        
        // 60일 이동평균선
        const ma60Data = calculateMovingAverage(candlestickData, 60);
        if (ma60Data.length > 0) {
          const ma60Series = chart.addLineSeries({
            color: '#45B7D1',
            lineWidth: 1,
            title: 'MA60',
          });
          ma60Series.setData(ma60Data);
        }
        
        // 120일 이동평균선
        const ma120Data = calculateMovingAverage(candlestickData, 120);
        if (ma120Data.length > 0) {
          const ma120Series = chart.addLineSeries({
            color: '#9C27B0', // 보라색
            lineWidth: 1,
            title: 'MA120',
          });
          ma120Series.setData(ma120Data);
        }
        
        // 240일 이동평균선
        const ma240Data = calculateMovingAverage(candlestickData, 240);
        if (ma240Data.length > 0) {
          const ma240Series = chart.addLineSeries({
            color: '#000000', // 검은색
            lineWidth: 1,
            title: 'MA240',
          });
          ma240Series.setData(ma240Data);
        }
      } catch (error) {
        console.error('이동평균선 추가 실패:', error);
      }
    }
    
    // 전역 변수에 저장
    stockChart = chart;
  }
  
  // 이동평균선 계산 함수
  function calculateMovingAverage(data, period) {
    const result = [];
    
    for (let i = period - 1; i < data.length; i++) {
      let sum = 0;
      for (let j = 0; j < period; j++) {
        sum += data[i - j].close;
      }
      const average = sum / period;
      
      result.push({
        time: data[i].time,
        value: average
      });
    }
    
    return result;
  }

  function renderInvestorChart(investorData) {
    const chartContainer = document.getElementById('investorChart');
    
    // 기존 차트 제거
    if (investorChart) {
      investorChart.remove();
      investorChart = null;
    }
    
    // 컨테이너 초기화
    chartContainer.innerHTML = '';
    
    const rawData = investorData.stk_invsr_orgn_chart || [];
    
    // 데이터 가공
    const individualData = [];
    const foreignData = [];
    const institutionalData = [];
    
    rawData.forEach(item => {
      const date = item.dt || '';
      if (date) {
        // YYYYMMDD 형식을 Unix timestamp로 변환
        const year = parseInt(date.substring(0, 4));
        const month = parseInt(date.substring(4, 6)) - 1;
        const day = parseInt(date.substring(6, 8));
        const timestamp = Math.floor(new Date(year, month, day).getTime() / 1000);
        
        individualData.push({
          time: timestamp,
          value: parseFloat(item.ind_invsr || 0)
        });
        
        foreignData.push({
          time: timestamp,
          value: parseFloat(item.frgnr_invsr || 0)
        });
        
        institutionalData.push({
          time: timestamp,
          value: parseFloat(item.orgn || 0)
        });
      }
    });
    
    // 최근 데이터부터 표시 (역순 정렬)
    individualData.reverse();
    foreignData.reverse();
    institutionalData.reverse();
    
    // 투자자별 차트 생성
    const containerWidth = chartContainer.clientWidth || 800;
    const containerHeight = 300;
    
    const chart = LightweightCharts.createChart(chartContainer, {
      width: containerWidth,
      height: containerHeight,
      layout: {
        backgroundColor: '#ffffff',
        textColor: '#333',
      },
      grid: {
        vertLines: {
          color: '#f0f0f0',
        },
        horzLines: {
          color: '#f0f0f0',
        },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
      rightPriceScale: {
        borderColor: '#cccccc',
      },
      timeScale: {
        borderColor: '#cccccc',
        timeVisible: true,
        secondsVisible: false,
      },
    });
    
    // 개인투자자 라인
    const individualSeries = chart.addLineSeries({
      color: '#dc3545',
      lineWidth: 2,
      title: '개인투자자',
    });
    
    // 외국인투자자 라인
    const foreignSeries = chart.addLineSeries({
      color: '#007bff',
      lineWidth: 2,
      title: '외국인투자자',
    });
    
    // 기관계 라인
    const institutionalSeries = chart.addLineSeries({
      color: '#28a745',
      lineWidth: 2,
      title: '기관계',
    });
    
    // 데이터 설정 (안전한 처리)
    try {
      if (individualData.length > 0) {
        individualSeries.setData(individualData);
      }
      if (foreignData.length > 0) {
        foreignSeries.setData(foreignData);
      }
      if (institutionalData.length > 0) {
        institutionalSeries.setData(institutionalData);
      }
    } catch (error) {
      console.error('투자자별 차트 데이터 설정 실패:', error);
    }
    
    // 차트 리사이즈 처리 (디바운싱 적용)
    let resizeTimeout;
    const handleResize = () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (chart) {
          const newWidth = chartContainer.clientWidth || 800;
          chart.applyOptions({ width: newWidth, height: containerHeight });
        }
      }, 100);
    };
    
    const resizeObserver = new ResizeObserver(handleResize);
    resizeObserver.observe(chartContainer);
    
    // 윈도우 리사이즈 이벤트도 처리
    window.addEventListener('resize', handleResize);
    
    // 전역 변수에 저장
    investorChart = chart;
  }

  function toggleChartView(viewType) {
    currentChartView = viewType;
    
    // 버튼 활성화 상태 업데이트
    document.querySelectorAll('.btn-group button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // 현재 선택된 버튼 활성화
    const activeBtn = document.getElementById(viewType + 'Btn');
    if (activeBtn) {
      activeBtn.classList.add('active');
    }
    
    // 차트 다시 렌더링
    loadChart();
  }

  function refreshChart() {
    loadChart();
    showAlert("차트가 새로고침되었습니다.", "success");
  }

  function showChartLoading() {
    const chartContainer = document.getElementById('stockChart');
    
    // 기존 차트 제거
    if (stockChart) {
      stockChart.remove();
      stockChart = null;
    }
    
    // 로딩 메시지 표시
    chartContainer.innerHTML = `
      <div class="d-flex align-items-center justify-content-center" style="height: 500px; color: #666;">
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">로딩중...</span>
          </div>
          <h5>차트 데이터를 불러오는 중...</h5>
        </div>
      </div>
    `;
  }

  function showChartError(message) {
    const chartContainer = document.getElementById('stockChart');
    
    // 기존 차트 제거
    if (stockChart) {
      stockChart.remove();
      stockChart = null;
    }
    
    // 에러 메시지 표시
    chartContainer.innerHTML = `
      <div class="d-flex align-items-center justify-content-center" style="height: 500px; color: #dc3545;">
        <div class="text-center">
          <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
          <h5>차트 로드 실패</h5>
          <p class="mb-0">${message}</p>
        </div>
      </div>
    `;
  }

  function getChartTypeName(chartType) {
    const names = {
      'daily': '일봉',
      'weekly': '주봉',
      'monthly': '월봉',
      'yearly': '년봉',
      'minute': '분봉',
      'tick': '틱차트'
    };
    return names[chartType] || chartType;
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    
    // YYYYMMDDHHMMSS 형식 (분봉, 틱차트)
    if (dateStr.length === 14) {
      return dateStr.slice(0, 4) + '-' + dateStr.slice(4, 6) + '-' + dateStr.slice(6, 8) + 
             ' ' + dateStr.slice(8, 10) + ':' + dateStr.slice(10, 12) + ':' + dateStr.slice(12, 14);
    }
    
    // YYYYMMDD 형식 (일봉, 주봉, 월봉, 년봉)
    if (dateStr.length === 8) {
      return dateStr.slice(0, 4) + '-' + dateStr.slice(4, 6) + '-' + dateStr.slice(6, 8);
    }
    
    // HHMMSS 형식 (시간)
    if (dateStr.length === 6) {
      return dateStr.slice(0, 2) + ':' + dateStr.slice(2, 4) + ':' + dateStr.slice(4, 6);
    }
    
    return dateStr;
  }

  // 기간에 따른 차트 데이터 필터링
  function filterChartDataByPeriod(data, chartType) {
    const period = document.getElementById('chartPeriod').value;
    
    // 'all'이면 필터링하지 않음
    if (period === 'all') {
      return data;
    }
    
    const days = parseInt(period);
    const today = new Date();
    const cutoffDate = new Date(today.getTime() - days * 24 * 60 * 60 * 1000);
    
    // 차트 타입에 따른 데이터 키 찾기
    let dataKey = '';
    switch (chartType) {
      case 'daily':
        dataKey = 'stk_dt_pole_chart_qry';
        break;
      case 'weekly':
        dataKey = 'stk_stk_pole_chart_qry';
        break;
      case 'monthly':
        dataKey = 'stk_mth_pole_chart_qry';
        break;
      case 'yearly':
        dataKey = 'stk_yr_pole_chart_qry';
        break;
      case 'minute':
        dataKey = 'stk_min_pole_chart_qry';
        break;
      case 'tick':
        dataKey = 'stk_tic_chart_qry';
        break;
    }
    
    if (!dataKey || !data[dataKey]) {
      return data;
    }
    
    // 데이터 필터링
    const filteredData = { ...data };
    filteredData[dataKey] = data[dataKey].filter(item => {
      // 차트 타입에 따라 날짜 필드 선택
      let dateStr = '';
      if (chartType === 'minute' || chartType === 'tick') {
        dateStr = item.cntr_tm || '';
        // YYYYMMDDHHMMSS 형식에서 YYYYMMDD 부분만 추출
        if (dateStr.length >= 8) {
          dateStr = dateStr.substring(0, 8);
        }
      } else {
        dateStr = item.dt || item.trde_dt || '';
      }
      
      if (!dateStr) return false;
      
      // YYYYMMDD 형식을 Date 객체로 변환
      const year = parseInt(dateStr.substring(0, 4));
      const month = parseInt(dateStr.substring(4, 6)) - 1; // 월은 0부터 시작
      const day = parseInt(dateStr.substring(6, 8));
      const itemDate = new Date(year, month, day);
      
      return itemDate >= cutoffDate;
    });
    
    return filteredData;
  }
</script>
{% endblock %}
