{% extends "base.html" %} {% block title %}자동매매 - 키움 자동매매{% endblock
%} {% block content %}
<div class="row">
  <!-- 자동매매 상태 카드 -->
  <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 mb-4">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">자동매매 상태</h6>
            <h6 class="mb-0" id="auto-trading-status">OFF</h6>
          </div>
          <div class="align-self-center">
            <i class="fas fa-robot fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 스케줄러 체크 카드 -->
  <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 mb-4">
    <div class="card bg-danger text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">장중 손절 감시</h6>
            <h6 class="mb-0" id="intraday-stop-status">OFF</h6>
          </div>
          <div class="align-self-center">
            <i class="fas fa-shield-alt fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 마지막 실행 카드 -->
  <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 mb-4">
    <div class="card bg-info text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">마지막 실행</h6>
            <h6 class="mb-0" id="last-execution">-</h6>
          </div>
          <div class="align-self-center">
            <i class="fas fa-clock fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 오늘 실행 여부 카드 -->
  <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 mb-4">
    <div class="card bg-success text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="card-title">오늘 실행 여부</h6>
            <h6 class="mb-0" id="today-execution">-</h6>
          </div>
          <div class="align-self-center">
            <i class="fas fa-calendar-check fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 실행 진행 상황 표시 -->
<div class="row mb-4" id="execution-progress" style="display: none">
  <div class="col-12">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
          <i class="fas fa-cog fa-spin me-2"></i>자동매매 실행 중
        </h6>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span id="current-status">시작 중...</span>
          <span id="progress-percentage">0%</span>
        </div>
        <div class="progress">
          <div
            class="progress-bar progress-bar-striped progress-bar-animated"
            id="progress-bar"
            role="progressbar"
            style="width: 0%"
          ></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- 자동매매 설정 -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>자동매매 설정</h5>
      </div>
      <div class="card-body">
        <form id="auto-trading-config-form">
          <!-- 자동매매 ON/OFF -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="auto-trading-enabled"
              />
              <label class="form-check-label" for="auto-trading-enabled">
                자동매매 활성화
              </label>
            </div>
          </div>

          <!-- 스케줄 설정 -->
          <div class="mb-3">
            <label class="form-label">실행 시간</label>
            <div class="row">
              <div class="col-6">
                <select class="form-select" id="schedule-hour">
                  <option value="00">00시</option>
                  <option value="01">01시</option>
                  <option value="02">02시</option>
                  <option value="03">03시</option>
                  <option value="04">04시</option>
                  <option value="05">05시</option>
                  <option value="06">06시</option>
                  <option value="07">07시</option>
                  <option value="08">08시</option>
                  <option value="09">09시</option>
                  <option value="10">10시</option>
                  <option value="11">11시</option>
                  <option value="12">12시</option>
                  <option value="13">13시</option>
                  <option value="14">14시</option>
                  <option value="15">15시</option>
                  <option value="16">16시</option>
                  <option value="17">17시</option>
                  <option value="18">18시</option>
                  <option value="19">19시</option>
                  <option value="20">20시</option>
                  <option value="21">21시</option>
                  <option value="22">22시</option>
                  <option value="23">23시</option>
                </select>
              </div>
              <div class="col-6">
                <select class="form-select" id="schedule-minute">
                  <option value="00">00분</option>
                  <option value="05">05분</option>
                  <option value="10">10분</option>
                  <option value="15">15분</option>
                  <option value="20">20분</option>
                  <option value="25">25분</option>
                  <option value="30">30분</option>
                  <option value="35">35분</option>
                  <option value="40">40분</option>
                  <option value="45">45분</option>
                  <option value="50">50분</option>
                  <option value="55">55분</option>
                </select>
              </div>
            </div>
            <div class="form-text" id="next-execution-info">
              다음 실행 시간을 계산하는 중...
            </div>
          </div>

          <!-- 전략 설정 -->
          <div class="mb-3">
            <label for="reserve-cash" class="form-label"
              >매매 제외 예수금 (원)</label
            >
            <input
              type="number"
              class="form-control"
              id="reserve-cash"
              min="0"
              step="1000"
              value="1000000"
            />
            <div class="form-text">
              이 금액은 매매에서 제외하고 보유합니다. (0원 가능)
            </div>
          </div>

          <div class="mb-3">
            <label for="max-hold-period" class="form-label"
              >최대 보유 기간 (일)</label
            >
            <input
              type="number"
              class="form-control"
              id="max-hold-period"
              min="1"
              value="15"
            />
          </div>

          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="take-profit-pct" class="form-label"
                  >익절률 (%)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="take-profit-pct"
                  min="0.1"
                  step="0.1"
                  value="5.0"
                />
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label for="stop-loss-pct" class="form-label">손절률 (%)</label>
                <input
                  type="number"
                  class="form-control"
                  id="stop-loss-pct"
                  min="0.1"
                  step="0.1"
                  value="3.0"
                />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="top-n" class="form-label">매수 종목 수</label>
                <input
                  type="number"
                  class="form-control"
                  id="top-n"
                  min="1"
                  value="5"
                />
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label for="buy-universe-rank" class="form-label"
                  >매수 대상 범위</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="buy-universe-rank"
                  min="1"
                  value="20"
                />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="transaction-fee-rate" class="form-label"
                  >거래 수수료율 (%)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="transaction-fee-rate"
                  min="0"
                  max="1"
                  step="0.001"
                  value="0.015"
                />
                <div class="form-text">기본값: 0.015% (키움증권 기준)</div>
              </div>
            </div>
          </div>

          <hr />

          <!-- 매수 주문 방식/안전장치 -->
          <div class="mb-3">
            <h6 class="mb-2">
              <i class="fas fa-shield-alt me-2"></i>매수 주문 방식(고가매수 방지)
            </h6>
            <label for="buy-order-method" class="form-label">매수 주문 방식</label>
            <select class="form-select" id="buy-order-method">
              <option value="market">시장가(기존)</option>
              <option value="limit_ask1">매도1호가 지정가(추천)</option>
            </select>
            <div class="form-text">
              시장가 매수는 호가가 비정상적으로 벌어진 순간 <strong>고가 체결</strong> 위험이 있습니다.
              매도1호가 지정가는 보통 <strong>즉시 체결 가능성이 높으면서</strong> 고가 튐을 줄이는 편입니다.
            </div>
          </div>

          <div class="mb-3" id="limit-buy-guard-section">
            <div class="row">
              <div class="col-6">
                <label for="limit-buy-max-premium-pct" class="form-label"
                  >가드 기준: 현재가 대비 매도1호가 허용(%)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="limit-buy-max-premium-pct"
                  min="0"
                  step="0.1"
                  value="1.0"
                />
                <div class="form-text">
                  예: 1.0이면 매도1호가가 현재가보다 <strong>+1%</strong> 초과 시 가드가 발동합니다.
                </div>
              </div>
              <div class="col-6">
                <label for="limit-buy-guard-action" class="form-label">가드 발동 시 처리</label>
                <select class="form-select" id="limit-buy-guard-action">
                  <option value="skip">매수 스킵(고가매수 방지 우선)</option>
                  <option value="market_fallback">시장가로 폴백(체결 우선)</option>
                </select>
                <div class="form-text">
                  “시장가로 폴백”은 체결은 잘 되지만, 고가 체결 위험이 다시 생길 수 있습니다.
                </div>
              </div>
            </div>
          </div>

          <hr />

          <!-- 장중 손절 감시 (자동매매와 별개) -->
          <div class="mb-3">
            <h6 class="mb-2">
              <i class="fas fa-shield-alt me-2"></i>장중 손절 감시
            </h6>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="intraday-stop-enabled"
              />
              <label class="form-check-label" for="intraday-stop-enabled">
                활성화 (평가손익률 기준)
              </label>
            </div>
            <div class="form-text">
              자동매매 ON/OFF와 무관하게, 보유종목의 <strong>평가손익률</strong>이 기준 이하가 되면
              <strong>전량 시장가 매도</strong>합니다.
            </div>
          </div>

          <div class="mb-3">
            <label for="intraday-stop-threshold" class="form-label"
              >손절 기준(%)</label
            >
            <input
              type="number"
              class="form-control"
              id="intraday-stop-threshold"
              step="0.1"
              value="-7.0"
            />
            <div class="form-text">
              예: <strong>-7</strong> 입력 시 평가손익률이 -7% 이하로 하락하면 매도합니다.
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>설정 저장
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 실행 제어 -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-play me-2"></i>실행 제어</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-outline-secondary" id="deeplearning-config-btn">
            <i class="fas fa-network-wired me-1"></i>분석서버 설정
            <span class="badge bg-secondary ms-2" id="deeplearning-status-badge">미확인</span>
          </button>
          <button type="button" class="btn btn-info" id="test-analysis-btn">
            <i class="fas fa-search me-1"></i>분석 결과 확인
          </button>
          <button type="button" class="btn btn-success" id="manual-execute-btn">
            <i class="fas fa-play me-1"></i>수동 실행
          </button>
          <button type="button" class="btn btn-warning" id="emergency-stop-btn">
            <i class="fas fa-stop me-1"></i>긴급 중지
          </button>
        </div>

        <hr />

        <h6>실행 이력</h6>
        <div class="table-responsive">
          <table class="table table-sm" id="execution-history-table">
            <thead>
              <tr>
                <th>실행일시</th>
                <th>구분</th>
                <th>상태</th>
                <th>매수</th>
                <th>매도</th>
                <th>상세</th>
              </tr>
            </thead>
            <tbody id="execution-history-tbody">
              <tr>
                <td colspan="6" class="text-center text-muted">
                  실행 이력이 없습니다.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 분석 서버 설정 모달 -->
<div class="modal fade" id="deeplearningConfigModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-secondary text-white border-0">
        <h5 class="modal-title">
          <i class="fas fa-network-wired me-2"></i>분석 서버 설정 (kiwoomDeepLearning)
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row g-3">
          <div class="col-7">
            <label class="form-label">Host</label>
            <input type="text" class="form-control" id="deeplearning-host" placeholder="127.0.0.1" />
          </div>
          <div class="col-5">
            <label class="form-label">Port</label>
            <input type="number" class="form-control" id="deeplearning-port" placeholder="5000" min="1" max="65535" />
          </div>
        </div>
        <div class="form-text mt-2">
          기본값은 <strong>127.0.0.1:5000</strong> 입니다. (WSL에서 실행 시에도 localhost 포워딩 가정)
        </div>
        <hr />
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary" id="deeplearning-test-btn">
            <i class="fas fa-stethoscope me-1"></i>연결 테스트
          </button>
          <button type="button" class="btn btn-primary" id="deeplearning-save-btn">
            <i class="fas fa-save me-1"></i>저장
          </button>
        </div>
        <div class="mt-3">
          <pre
            class="p-3 border rounded small mb-0 bg-body-tertiary text-body"
            id="deeplearning-test-result"
            style="white-space: pre-wrap; word-break: break-word; max-height: 240px; overflow: auto;"
          >-</pre>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 실행이력 상세 모달 -->
<div class="modal fade" id="executionDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="executionDetailTitle">실행이력 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="executionDetailContent">
          <!-- 상세 내용이 여기에 표시됩니다 -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 수동 실행 확인 모달 -->
<div class="modal fade" id="manualExecuteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0">
        <h5 class="modal-title">
          <i class="fas fa-play-circle me-2"></i>수동 실행 확인
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <div class="mb-3">
            <i class="fas fa-robot fa-3x text-primary"></i>
          </div>
          <h6 class="mb-3">자동매매를 수동으로 실행하시겠습니까?</h6>
        </div>

        <div class="alert alert-warning border-0 shadow-sm">
          <div class="d-flex align-items-start">
            <i class="fas fa-exclamation-triangle text-warning me-3 mt-1"></i>
            <div>
              <strong>주의사항:</strong>
              <ul class="mb-0 mt-2">
                <li>실제 주문이 발생할 수 있습니다</li>
                <li>현재 설정된 전략으로 매매가 실행됩니다</li>
                <li>신중히 결정해주세요</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          <i class="fas fa-times me-1"></i>취소
        </button>
        <button
          type="button"
          class="btn btn-primary"
          id="confirm-manual-execute"
        >
          <i class="fas fa-play me-1"></i>실행
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 분석 결과 확인 모달 -->
<div class="modal fade" id="analysisResultModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-info text-white border-0">
        <h5 class="modal-title">
          <i class="fas fa-chart-line me-2"></i>분석 결과 확인
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4">
        <!-- 분석 정보 -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title">분석 정보</h6>
                <p class="mb-1">
                  <strong>분석 날짜:</strong> <span id="analysis-date">-</span>
                </p>
                <p class="mb-1">
                  <strong>총 종목 수:</strong> <span id="total-stocks">-</span>
                </p>
                <p class="mb-0">
                  <strong>매수 대상:</strong>
                  <span id="buy-candidates-count">-</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title">전략 파라미터</h6>
                <p class="mb-1">
                  <strong>매수 종목 수:</strong>
                  <span id="strategy-top-n">-</span>
                </p>
                <p class="mb-1">
                  <strong>매수 범위:</strong>
                  <span id="strategy-universe">-</span>
                </p>
                <p class="mb-1">
                  <strong>수수료율:</strong>
                  <span id="strategy-fee-rate">-</span>
                </p>
                <p class="mb-1">
                  <strong>예약 현금:</strong>
                  <span id="strategy-reserve">-</span>
                </p>
                <p class="mb-0">
                  <strong>사용가능금액:</strong>
                  <span id="available-cash" class="text-primary fw-bold"
                    >-</span
                  >
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- 상위 종목 리스트 -->
        <div class="mb-4">
          <h6 style="color: black;">상위 종목 리스트 (상위 20개)</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover" id="top-stocks-table">
              <thead class="table-light">
                <tr>
                  <th>최종순위</th>
                  <th>종목명</th>
                  <th>종목코드</th>
                  <th>현재가</th>
                  <th>시가총액(억)</th>
                  <th>RF상승확률</th>
                  <th>LGBM상승확률</th>
                  <th>최종점수</th>
                </tr>
              </thead>
              <tbody id="top-stocks-tbody">
                <tr>
                  <td colspan="8" class="text-center text-muted">
                    분석 결과를 불러오는 중...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 매도 대상 종목 -->
        <div class="mb-4">
          <h6 style="color: black;">매도 대상 종목</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover" id="sell-candidates-table">
              <thead class="table-danger">
                <tr>
                  <th>종목명</th>
                  <th>종목코드</th>
                  <th>보유수량</th>
                  <th>평균단가</th>
                  <th>현재가</th>
                  <th>수익률</th>
                  <th>보유기간</th>
                  <th>매도예상금액</th>
                  <th>매도사유</th>
                </tr>
              </thead>
              <tbody id="sell-candidates-tbody">
                <tr>
                  <td colspan="9" class="text-center text-muted">
                    매도 대상을 불러오는 중...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 매수 대상 종목 (매도 후) -->
        <div class="mb-4">
          <h6 style="color: black;">매수 대상 종목 (매도 후)</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover" id="buy-candidates-table">
              <thead class="table-success">
                <tr>
                  <th>최종순위</th>
                  <th>종목명</th>
                  <th>종목코드</th>
                  <th>현재가</th>
                  <th>시가총액(억)</th>
                  <th>RF상승확률</th>
                  <th>LGBM상승확률</th>
                  <th>최종점수</th>
                </tr>
              </thead>
              <tbody id="buy-candidates-tbody">
                <tr>
                  <td colspan="8" class="text-center text-muted">
                    매수 대상을 불러오는 중...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          <i class="fas fa-times me-1"></i>닫기
        </button>
        <button
          type="button"
          class="btn btn-success"
          id="execute-with-candidates"
        >
          <i class="fas fa-play me-1"></i>매도 후 매수 실행
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 긴급 중지 확인 모달 -->
<div class="modal fade" id="emergencyStopModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white border-0">
        <h5 class="modal-title">
          <i class="fas fa-stop-circle me-2"></i>긴급 중지 확인
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <div class="mb-3">
            <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
          </div>
          <h6 class="mb-3">자동매매를 긴급 중지하시겠습니까?</h6>
        </div>

        <div class="alert alert-danger border-0 shadow-sm">
          <div class="d-flex align-items-start">
            <i class="fas fa-exclamation-triangle text-danger me-3 mt-1"></i>
            <div>
              <strong>주의사항:</strong>
              <ul class="mb-0 mt-2">
                <li>진행 중인 자동매매가 즉시 중단됩니다</li>
                <li>미체결 주문은 그대로 유지됩니다</li>
                <li>다시 시작하려면 수동으로 실행해야 합니다</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          <i class="fas fa-times me-1"></i>취소
        </button>
        <button
          type="button"
          class="btn btn-danger"
          id="confirm-emergency-stop"
        >
          <i class="fas fa-stop me-1"></i>중지
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<style>
  /* 자동매매 상태 카드 스타일 */

  /* 점이 늘어나는 로딩 애니메이션 */
  .loading-dots {
    display: inline-flex;
    align-items: center;
    gap: 2px;
  }

  .loading-dots .dot {
    width: 4px;
    height: 4px;
    background-color: currentColor;
    border-radius: 50%;
    animation: loading-dots 1.5s infinite ease-in-out;
  }

  .loading-dots .dot:nth-child(1) {
    animation-delay: 0s;
  }

  .loading-dots .dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .loading-dots .dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes loading-dots {
    0%,
    80%,
    100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1.2);
      opacity: 1;
    }
  }

  /* 상태 텍스트 스타일 */
  #auto-trading-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* 보라색 배경 (ON 상태) */
  .bg-purple {
    background-color: #6f42c1 !important;
  }

  .bg-purple:hover {
    background-color: #5a32a3 !important;
  }
</style>
<script>
  // 자동매매 페이지 전용 JavaScript
  document.addEventListener("DOMContentLoaded", function () {
    // 서버 정보 즉시 업데이트
    updateServerInfoFromTemplate();

    loadAutoTradingConfig();
    loadExecutionHistory();
    updateAutoTradingStatus(); // 초기 상태 업데이트
    updateNextExecutionInfo(); // 다음 실행 시간 업데이트

    // 30초마다 상태 업데이트
    setInterval(updateAutoTradingStatus, 30000);

    // 시간 변경 시 다음 실행 시간 업데이트
    document.getElementById("schedule-hour").addEventListener("change", updateNextExecutionInfo);
    document.getElementById("schedule-minute").addEventListener("change", updateNextExecutionInfo);

    // 매수 주문 방식 변경 시 UI 토글
    const methodEl = document.getElementById("buy-order-method");
    if (methodEl) {
      methodEl.addEventListener("change", updateBuyOrderGuardUI);
    }
  });

  function updateBuyOrderGuardUI() {
    const method = document.getElementById("buy-order-method")?.value || "market";
    const guardSection = document.getElementById("limit-buy-guard-section");
    const maxPremiumEl = document.getElementById("limit-buy-max-premium-pct");
    const guardActionEl = document.getElementById("limit-buy-guard-action");

    // limit_ask1일 때만 가드 섹션 활성화(시장가면 의미 없음)
    const enable = method === "limit_ask1";
    if (guardSection) guardSection.style.opacity = enable ? "1" : "0.5";
    if (maxPremiumEl) maxPremiumEl.disabled = !enable;
    if (guardActionEl) guardActionEl.disabled = !enable;
  }

  function updateServerInfoFromTemplate() {
    // 템플릿에서 전달받은 서버 정보로 즉시 업데이트
    {% if server_info %}
    const serverNameElement = document.getElementById('server-name');
    const serverInfoElement = document.getElementById('server-info');

    if (serverNameElement && serverInfoElement) {
      serverNameElement.textContent = '{{ server_info.server_name }}';

      // 서버별 색상 적용
      if ('{{ server_info.server_type }}' === 'mock') {
        serverInfoElement.style.color = '#4CAF50';
      } else {
        serverInfoElement.style.color = '#F44336';
      }
    }
    {% endif %}
  }

  // 다음 실행 시간 정보 업데이트
  function updateNextExecutionInfo() {
    const hour = document.getElementById("schedule-hour").value;
    const minute = document.getElementById("schedule-minute").value;
    const scheduleTime = `${hour}:${minute}`;

    // 현재 시간과 비교하여 다음 실행 시간 계산
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const scheduledTime = new Date(today.getTime() + parseInt(hour) * 60 * 60 * 1000 + parseInt(minute) * 60 * 1000);

    let nextExecutionDate;
    let executionStatus;

    if (scheduledTime > now) {
      // 오늘 실행 예정
      nextExecutionDate = scheduledTime;
      executionStatus = "오늘";
    } else {
      // 내일 실행 예정
      nextExecutionDate = new Date(scheduledTime.getTime() + 24 * 60 * 60 * 1000);
      executionStatus = "내일";
    }

    const year = nextExecutionDate.getFullYear();
    const month = (nextExecutionDate.getMonth() + 1).toString().padStart(2, '0');
    const day = nextExecutionDate.getDate().toString().padStart(2, '0');
    const timeStr = `${hour}시 ${minute}분`;

    const infoElement = document.getElementById("next-execution-info");
    infoElement.innerHTML = `다음 실행 시간: ${year}년 ${month}월 ${day}일 ${timeStr} (${executionStatus})`;
  }

  // 설정 로드
  function loadAutoTradingConfig() {
    fetch("/api/auto-trading/config")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const config = data.data;
          document.getElementById("auto-trading-enabled").checked =
            config.auto_trading_enabled;

          // 시간 설정 로드
          const scheduleTime = config.schedule_time || "08:30";
          const [hour, minute] = scheduleTime.split(':');
          document.getElementById("schedule-hour").value = hour;
          document.getElementById("schedule-minute").value = minute;

          // 다음 실행 시간 업데이트
          updateNextExecutionInfo();
          document.getElementById("reserve-cash").value =
            config.strategy_params?.reserve_cash ?? 1000000;
          document.getElementById("max-hold-period").value =
            config.strategy_params?.max_hold_period || 15;
          document.getElementById("take-profit-pct").value =
            config.strategy_params?.take_profit_pct || 5.0;
          document.getElementById("stop-loss-pct").value =
            config.strategy_params?.stop_loss_pct || 3.0;
          document.getElementById("top-n").value =
            config.strategy_params?.top_n || 5;
          document.getElementById("buy-universe-rank").value =
            config.strategy_params?.buy_universe_rank || 20;
          document.getElementById("transaction-fee-rate").value =
            config.strategy_params?.transaction_fee_rate || 0.015;

          // 매수 주문 방식/가드 설정 로드
          document.getElementById("buy-order-method").value =
            config.strategy_params?.buy_order_method || "market";
          document.getElementById("limit-buy-max-premium-pct").value =
            config.strategy_params?.limit_buy_max_premium_pct ?? 1.0;
          document.getElementById("limit-buy-guard-action").value =
            config.strategy_params?.limit_buy_guard_action || "skip";
          updateBuyOrderGuardUI();

          // 장중 손절 감시 설정 로드
          document.getElementById("intraday-stop-enabled").checked =
            config.intraday_stop_loss?.enabled ?? false;
          document.getElementById("intraday-stop-threshold").value =
            config.intraday_stop_loss?.threshold_pct ?? -7.0;
        }
      })
      .catch((error) => {
        console.error("설정 로드 실패:", error);
        showAlert("설정을 불러오는데 실패했습니다.", "danger");
      });
  }

  // 설정 저장
  document
    .getElementById("auto-trading-config-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      // 시간 설정 조합
      const hour = document.getElementById("schedule-hour").value;
      const minute = document.getElementById("schedule-minute").value;
      const scheduleTime = `${hour}:${minute}`;

      const config = {
        auto_trading_enabled: document.getElementById("auto-trading-enabled")
          .checked,
        schedule_time: scheduleTime,
        intraday_stop_loss: {
          enabled: document.getElementById("intraday-stop-enabled").checked,
          threshold_pct:
            parseFloat(document.getElementById("intraday-stop-threshold").value) || -7.0,
        },
        strategy_params: {
          reserve_cash:
            parseInt(document.getElementById("reserve-cash").value) || 0,
          max_hold_period:
            parseInt(document.getElementById("max-hold-period").value) || 15,
          take_profit_pct:
            parseFloat(document.getElementById("take-profit-pct").value) || 5.0,
          stop_loss_pct:
            parseFloat(document.getElementById("stop-loss-pct").value) || 3.0,
          top_n: parseInt(document.getElementById("top-n").value) || 5,
          buy_universe_rank:
            parseInt(document.getElementById("buy-universe-rank").value) || 20,
          transaction_fee_rate:
            parseFloat(document.getElementById("transaction-fee-rate").value) || 0.015,

          // 신규: 매수 주문 방식/가드 설정
          buy_order_method: document.getElementById("buy-order-method").value || "market",
          limit_buy_max_premium_pct:
            parseFloat(document.getElementById("limit-buy-max-premium-pct").value) ?? 1.0,
          limit_buy_guard_action: document.getElementById("limit-buy-guard-action").value || "skip",
        },
      };

      console.log("저장할 설정:", config);

      fetch("/api/auto-trading/config", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(config),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("설정이 저장되었습니다.", "success");
            // 설정 저장 후 상태 업데이트
            updateAutoTradingStatus();
            loadExecutionHistory();
          } else {
            showAlert(data.message || "설정 저장에 실패했습니다.", "danger");
          }
        })
        .catch((error) => {
          console.error("설정 저장 실패:", error);
          showAlert("설정 저장 중 오류가 발생했습니다.", "danger");
        });
    });

  // 자동매매 상태 업데이트
  function updateAutoTradingStatus() {
    fetch("/api/auto-trading/status")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const status = data.data;
          const statusElement = document.getElementById("auto-trading-status");
          const statusCard = statusElement.closest(".card");
          const intradayElement = document.getElementById("intraday-stop-status");
          const intradayCard = intradayElement?.closest(".card");

          if (status.enabled) {
            statusElement.innerHTML = `
                        <span>ON</span>
                        <div class="loading-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    `;
            statusCard.className = "card bg-purple text-white";
          } else {
            statusElement.innerHTML = "OFF";
            statusCard.className = "card bg-secondary text-white";
          }

          // 장중 손절 감시 상태 (스케줄러 체크 카드 대체)
          if (intradayElement && intradayCard) {
            if (status.intraday_stop_loss_enabled) {
              const th = status.intraday_stop_loss_threshold_pct ?? -7.0;
              intradayElement.innerHTML = `
                        <span>ON</span>
                        <div class="loading-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                        <small class="ms-2">(${th}%)</small>
                    `;
              intradayCard.className = "card bg-danger text-white";
            } else {
              intradayElement.innerHTML = "OFF";
              intradayCard.className = "card bg-secondary text-white";
            }
          }

          document.getElementById("last-execution").textContent =
            status.last_execution || "-";
          document.getElementById("today-execution").textContent =
            status.today_executed ? "실행됨" : "미실행";

          // 실행 진행 상황 업데이트
          updateExecutionProgress(status);
        }
      })
      .catch((error) => {
        console.error("상태 업데이트 실패:", error);
      });
  }

  // 실행 진행 상황 업데이트
  function updateExecutionProgress(status) {
    const progressCard = document.getElementById("execution-progress");
    const currentStatus = document.getElementById("current-status");
    const progressPercentage = document.getElementById("progress-percentage");
    const progressBar = document.getElementById("progress-bar");

    if (status.is_running) {
      progressCard.style.display = "block";
      currentStatus.textContent = status.current_status || "실행 중...";
      progressPercentage.textContent = (status.progress_percentage || 0) + "%";
      progressBar.style.width = (status.progress_percentage || 0) + "%";
    } else {
      progressCard.style.display = "none";
    }
  }

  // 진행 상황 모니터링 시작
  function startProgressMonitoring() {
    const interval = setInterval(() => {
      updateAutoTradingStatus();

      // 실행이 완료되면 모니터링 중단
      fetch("/api/auto-trading/status")
        .then((response) => response.json())
        .then((data) => {
          if (data.success && !data.data.is_running) {
            clearInterval(interval);
          }
        })
        .catch((error) => {
          console.error("진행 상황 확인 실패:", error);
          clearInterval(interval);
        });
    }, 1000); // 1초마다 업데이트
  }

  // 실행 이력 로드
  function loadExecutionHistory() {
    fetch("/api/auto-trading/history")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const tbody = document.getElementById("execution-history-tbody");
          tbody.innerHTML = "";

          if (data.data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="text-center text-muted">실행 이력이 없습니다.</td></tr>';
          } else {
            data.data.forEach((execution, index) => {
              const row = document.createElement("tr");

              // 실행 구분 파싱
              let executionType = "자동";
              let typeBadgeClass = "bg-info";
              if (execution.message && execution.message.includes("[수동]")) {
                executionType = "수동";
                typeBadgeClass = "bg-warning";
              }

              row.innerHTML = `
                            <td>${execution.execution_time}</td>
                            <td><span class="badge ${typeBadgeClass}">${executionType}</span></td>
                            <td><span class="badge ${
                              execution.status === "success"
                                ? "bg-success"
                                : "bg-danger"
                            }">${execution.status}</span></td>
                            <td>${execution.buy_count || 0}</td>
                            <td>${execution.sell_count || 0}</td>
                            <td>
                              <button class="btn btn-sm btn-outline-primary" onclick="showExecutionDetail(${index})">
                                <i class="fas fa-eye"></i> 상세
                              </button>
                            </td>
                        `;
              row.setAttribute('data-execution', JSON.stringify(execution));
              tbody.appendChild(row);
            });
          }
        }
      })
      .catch((error) => {
        console.error("실행 이력 로드 실패:", error);
      });
  }

  // 실행이력 상세 보기
  function showExecutionDetail(index) {
    const tbody = document.getElementById("execution-history-tbody");
    const rows = tbody.querySelectorAll('tr[data-execution]');
    
    if (index >= 0 && index < rows.length) {
      const executionData = JSON.parse(rows[index].getAttribute('data-execution'));
      
      // 모달 제목 설정
      document.getElementById('executionDetailTitle').textContent = 
        `실행이력 상세 - ${executionData.execution_time}`;
      
      // 상세 내용 생성
      const detailContent = generateExecutionDetailContent(executionData);
      document.getElementById('executionDetailContent').innerHTML = detailContent;
      
      // 모달 표시
      const modal = new bootstrap.Modal(document.getElementById('executionDetailModal'));
      modal.show();

      // 상세 JSON(미체결/실패 리스트 등) 로드해서 UI에 표시
      if (executionData.details_file) {
        loadExecutionDetailJson(executionData.details_file);
      }
    }
  }

  function loadExecutionDetailJson(detailsFile) {
    const container = document.getElementById("execution-extra-details");
    if (!container) return;
    container.innerHTML = `<div class="text-muted">상세 정보를 불러오는 중...</div>`;

    fetch(`/api/auto-trading/execution-detail?file=${encodeURIComponent(detailsFile)}`)
      .then((r) => r.json())
      .then((resp) => {
        if (!resp.success) throw new Error(resp.message || "상세 조회 실패");
        const data = resp.data || {};
        const buy = data.buy_results || {};
        const sell = data.sell_results || {};
        const unfilled = buy.unfilled_failures || [];
        const buyDetails = buy.details || [];
        const sellDetails = sell.details || [];
        const excludedCandidates = data.excluded_candidates || [];
        const excludedSummary = data.excluded_summary || {};
        const analysisMeta = data.analysis_meta || {};
        const analysisTop60 = data.analysis_top60 || [];
        const trace = data.execution_trace || [];

        const formatNumber = (num) => {
          if (num === null || num === undefined || num === "" || Number.isNaN(Number(num))) return "-";
          const n = Number(num);
          return new Intl.NumberFormat("ko-KR").format(n);
        };

        // 분석 원본데이터 기준: 시가총액은 '억' 단위로 내려옴 → 소숫점 제거 후 '억' 표기
        const formatMarketCapEok = (val) => {
          if (val === null || val === undefined || val === "" || Number.isNaN(Number(val))) return "-";
          const n = Number(val);
          if (!Number.isFinite(n)) return "-";
          return new Intl.NumberFormat("ko-KR").format(Math.floor(n)) + "억";
        };

        const escapeHtml = (unsafe) => {
          return String(unsafe ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        };

        const htmlParts = [];

        // 0) 분석 메타
        const metaRows = Object.entries(analysisMeta).map(([k, v]) => `
          <tr><td class="text-muted" style="width: 220px;"><strong>${escapeHtml(k)}</strong></td><td>${escapeHtml(v)}</td></tr>
        `).join("");
        if (metaRows) {
          htmlParts.push(`
            <div class="execution-section-title"><i class="fas fa-database"></i>분석/컨텍스트 스냅샷</div>
            <div class="table-responsive">
              <table class="table table-sm">
                <tbody>${metaRows}</tbody>
              </table>
            </div>
          `);
        }

        // 1) 매수 상세
        if (buyDetails.length) {
          const buySuccess = buyDetails.filter((x) => (x?.status || "") === "성공").length;
          const buySkipped = buyDetails.filter((x) => (x?.status || "") === "스킵").length;
          const buyFailed = buyDetails.filter((x) => (x?.status || "") === "실패").length;
          const getStatusBadge = (status) => {
            const s = String(status || "-");
            if (s === "성공") return `<span class="badge bg-success">${escapeHtml(s)}</span>`;
            if (s === "실패") return `<span class="badge bg-danger">${escapeHtml(s)}</span>`;
            if (s === "스킵") return `<span class="badge bg-secondary">${escapeHtml(s)}</span>`;
            return `<span class="badge bg-light text-dark">${escapeHtml(s)}</span>`;
          };
          const rows = buyDetails.map((x, idx) => `
            <tr>
              <td>${idx + 1}</td>
              <td>${escapeHtml(x.stock_name || "-")}</td>
              <td>${escapeHtml(x.stock_code || "-")}</td>
              <td>${getStatusBadge(x.status)}</td>
              <td>${formatNumber(x.quantity)}주</td>
              <td>${formatNumber(x.price)}원</td>
              <td>${formatNumber(x.amount)}원</td>
              <td>${escapeHtml(x.reason || "-")}</td>
              <td class="text-muted">${escapeHtml(x.error_message || "")}</td>
            </tr>
          `).join("");
          htmlParts.push(`
            <div class="execution-section-title"><i class="fas fa-arrow-up"></i>매수 상세 내역 (총 ${buyDetails.length}건 | 성공 ${buySuccess} | 스킵 ${buySkipped} | 실패 ${buyFailed})</div>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>#</th><th>종목명</th><th>코드</th><th>상태</th><th>수량</th><th>가격</th><th>금액</th><th>사유</th><th>오류</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `);
        }

        // 2) 매도 상세
        if (sellDetails.length) {
          const sellSuccess = sellDetails.filter((x) => (x?.status || "") === "성공").length;
          const sellFailed = sellDetails.filter((x) => (x?.status || "") === "실패").length;
          const getStatusBadge = (status) => {
            const s = String(status || "-");
            if (s === "성공") return `<span class="badge bg-success">${escapeHtml(s)}</span>`;
            if (s === "실패") return `<span class="badge bg-danger">${escapeHtml(s)}</span>`;
            return `<span class="badge bg-light text-dark">${escapeHtml(s)}</span>`;
          };
          const rows = sellDetails.map((x, idx) => {
            const reasonText = String(x.reason || "-");
            const reasonClass = reasonText.includes("익절")
              ? "text-up"
              : reasonText.includes("손절")
              ? "text-down"
              : "";
            const reasonHtml = reasonClass
              ? `<span class="${reasonClass}">${escapeHtml(reasonText)}</span>`
              : escapeHtml(reasonText);
            
            // 수익률 표시
            const profitRate = x.profit_rate !== undefined && x.profit_rate !== null ? Number(x.profit_rate) : null;
            let profitRateHtml = "-";
            if (profitRate !== null && !Number.isNaN(profitRate)) {
              const profitClass = profitRate > 0 ? "text-up" : profitRate < 0 ? "text-down" : "";
              const sign = profitRate > 0 ? "+" : "";
              profitRateHtml = `<span class="${profitClass}">${sign}${profitRate.toFixed(2)}%</span>`;
            }
            
            return `
            <tr>
              <td>${idx + 1}</td>
              <td>${escapeHtml(x.stock_name || "-")}</td>
              <td>${escapeHtml(x.stock_code || "-")}</td>
              <td>${getStatusBadge(x.status)}</td>
              <td>${formatNumber(x.quantity)}주</td>
              <td>${formatNumber(x.price)}원</td>
              <td>${formatNumber(x.amount)}원</td>
              <td>${profitRateHtml}</td>
              <td>${reasonHtml}</td>
              <td class="text-muted">${escapeHtml(x.error_message || "")}</td>
            </tr>
          `;
          }).join("");
          htmlParts.push(`
            <div class="execution-section-title"><i class="fas fa-arrow-down"></i>매도 상세 내역 (총 ${sellDetails.length}건 | 성공 ${sellSuccess} | 실패 ${sellFailed})</div>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>#</th><th>종목명</th><th>코드</th><th>상태</th><th>수량</th><th>가격</th><th>금액</th><th>수익률</th><th>사유</th><th>오류</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `);
        }

        // 2.5) 분석서버 원본 Top 40 (사용자 확인용) - 매수/매도 상세 아래로 이동
        // - 서버에서 40개로 잘라 내려오지만, 과거 실행 파일 호환을 위해 UI에서도 40개로 제한
        if (analysisTop60.length) {
          const topLimit = 40;
          const sorted = [...analysisTop60].sort((a, b) => {
            const ra = Number(a?.최종순위 ?? 999999);
            const rb = Number(b?.최종순위 ?? 999999);
            return ra - rb;
          }).slice(0, topLimit);

          const rows = sorted.map((x) => {
            const rank = x?.최종순위 ?? "-";
            const rfProba = (x?.rf_pred_proba != null ? x.rf_pred_proba : x?.ml_pred_proba);
            return `
              <tr>
                <td>${escapeHtml(rank)}</td>
                <td>${escapeHtml(x?.종목명 || "-")}</td>
                <td>${escapeHtml(x?.종목코드 || "-")}</td>
                <td>${formatMarketCapEok(x?.시가총액)}</td>
                <td>${rfProba != null ? (Number(rfProba) * 100).toFixed(1) + "%" : "-"}</td>
                <td>${x?.lgbm_pred_proba != null ? (Number(x.lgbm_pred_proba) * 100).toFixed(1) + "%" : "-"}</td>
                <td>${x?.final_score != null ? (Number(x.final_score)).toFixed(2) : "-"}</td>
              </tr>
            `;
          }).join("");

          htmlParts.push(`
            <div class="execution-section-title"><i class="fas fa-list-ol"></i>분석서버 원본 Top 40</div>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>최종순위</th><th>종목명</th><th>종목코드</th><th>시가총액(억)</th><th>RF상승확률</th><th>LGBM상승확률</th><th>최종점수</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
            ${analysisTop60.length > topLimit ? `<div class="text-muted">※ 과거 실행 파일 포함: 표시 제한 ${topLimit}건</div>` : ""}
          `);
        }

        // 3) 최종 미체결(잔량)
        if (!unfilled.length) {
          htmlParts.push(`
            <div class="execution-section-title"><i class="fas fa-check-circle"></i>최종 미체결(잔량)</div>
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>최종 미체결(잔량) 종목이 없습니다.
            </div>
          `);
        } else {
          const rows = unfilled.map((x, idx) => `
            <tr>
              <td>${idx + 1}</td>
              <td>${escapeHtml(x.stock_name || "-")}</td>
              <td>${escapeHtml(x.stock_code || "-")}</td>
              <td>${formatNumber(x.unfilled_qty || 0)}주</td>
              <td>${escapeHtml(x.ord_no || "-")}</td>
              <td>${x.max_price ? formatNumber(x.max_price) + "원" : "-"}</td>
              <td>${escapeHtml(x.guard_action || "-")}</td>
            </tr>
          `).join("");
          htmlParts.push(`
            <div class="execution-section-title"><i class="fas fa-exclamation-triangle"></i>최종 미체결(잔량) 종목 (${unfilled.length}건)</div>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-warning">
                  <tr>
                    <th>#</th><th>종목명</th><th>종목코드</th><th>미체결</th><th>주문번호</th><th>max_price</th><th>정책</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `);
        }

        // 4) 제외 후보(held_stock만 표기)
        const excludedHeld = (excludedCandidates || []).filter((x) => (x?.reason || "") === "held_stock");
        if (excludedHeld.length) {
          const limit = 200;
          // 최종순위 기준으로 정렬해서 표시(과거 실행상세도 UI에서 정렬 효과)
          const sorted = [...excludedHeld].sort((a, b) => {
            const ra = Number(a?.최종순위 ?? 999999);
            const rb = Number(b?.최종순위 ?? 999999);
            if (!Number.isFinite(ra) && !Number.isFinite(rb)) return 0;
            if (!Number.isFinite(ra)) return 1;
            if (!Number.isFinite(rb)) return -1;
            return ra - rb;
          });
          const sliced = sorted.slice(0, limit);
          const rows = sliced.map((x, idx) => {
            const rank = (x.최종순위 !== undefined && x.최종순위 !== null && x.최종순위 !== "" && x.최종순위 !== "-")
              ? x.최종순위
              : (idx + 1);
            const rfProba = (x.rf_pred_proba != null ? x.rf_pred_proba : x.ml_pred_proba);
            return `
            <tr>
              <td>${escapeHtml(rank)}</td>
              <td>${escapeHtml(x.종목명 || "-")}</td>
              <td>${escapeHtml(x.종목코드 || "-")}</td>
              <td>${formatMarketCapEok(x.시가총액)}</td>
              <td>${rfProba != null ? (Number(rfProba) * 100).toFixed(1) + "%" : "-"}</td>
              <td>${x.lgbm_pred_proba != null ? (Number(x.lgbm_pred_proba) * 100).toFixed(1) + "%" : "-"}</td>
              <td>${x.final_score != null ? (Number(x.final_score)).toFixed(2) : "-"}</td>
              <td><span class="badge bg-secondary">${escapeHtml(x.reason || "-")}</span></td>
            </tr>
          `}).join("");

          htmlParts.push(`
            <div class="execution-section-title"><i class="fas fa-filter"></i>제외된 후보(held_stock) (${excludedHeld.length}건)</div>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>최종순위</th><th>종목명</th><th>코드</th><th>시가총액(억)</th><th>RF상승확률</th><th>LGBM상승확률</th><th>최종점수</th><th>사유</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
            ${excludedHeld.length > limit ? `<div class="text-muted">※ 표시 제한: ${limit}건까지만 보여줍니다.</div>` : ""}
          `);
        }

        // 5) 실행 타임라인
        if (trace.length) {
          const rows = trace.map((x, idx) => `
            <tr>
              <td>${idx + 1}</td>
              <td>${escapeHtml(x.ts || "-")}</td>
              <td>${escapeHtml(x.stage || "-")}</td>
              <td>${escapeHtml(x.message || "")}</td>
              <td class="text-muted"><code>${escapeHtml(JSON.stringify(x.data || {}))}</code></td>
            </tr>
          `).join("");
          htmlParts.push(`
            <div class="execution-section-title"><i class="fas fa-stream"></i>실행 타임라인 (${trace.length}개 이벤트)</div>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>#</th><th>시각</th><th>단계</th><th>메시지</th><th>데이터</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `);
        }

        // 6) 원본 JSON(다운로드/복사 목적)
        const raw = escapeHtml(JSON.stringify(data, null, 2));
        htmlParts.push(`
          <div class="execution-section-title"><i class="fas fa-code"></i>원본 데이터</div>
          <details>
            <summary class="text-muted">원본 JSON 펼치기</summary>
            <pre class="p-3 border rounded small bg-body-tertiary text-body" style="white-space: pre-wrap; word-break: break-word; max-height: 420px; overflow: auto;">${raw}</pre>
          </details>
        `);

        container.innerHTML = htmlParts.join("\n");
      })
      .catch((e) => {
        container.innerHTML = `<div class="alert alert-danger">상세 정보를 불러오지 못했습니다: ${e.message}</div>`;
      });
  }

  // 실행이력 상세 내용 생성
  function generateExecutionDetailContent(execution) {
    const executionType = execution.message && execution.message.includes("[수동]") ? "수동" : "자동";
    const statusClass = execution.status === "success" ? "text-success" : "text-danger";
    const statusIcon = execution.status === "success" ? "fa-check-circle" : "fa-times-circle";
    
    const formatNumber = (num) => {
      if (!num || num === 0) return "0";
      return new Intl.NumberFormat('ko-KR').format(num);
    };
    
    return `
      <div class="row">
        <div class="col-md-6">
          <div class="execution-section-title"><i class="fas fa-info-circle"></i>기본 정보</div>
          <table class="table table-sm">
            <tr>
              <td><strong>실행 시간:</strong></td>
              <td>${execution.execution_time}</td>
            </tr>
            <tr>
              <td><strong>실행 유형:</strong></td>
              <td><span class="badge ${executionType === "수동" ? "bg-warning" : "bg-info"}">${executionType}</span></td>
            </tr>
            <tr>
              <td><strong>실행 상태:</strong></td>
              <td><i class="fas ${statusIcon} ${statusClass} me-1"></i><span class="${statusClass}">${execution.status}</span></td>
            </tr>
            <tr>
              <td><strong>메시지:</strong></td>
              <td>${execution.message || "없음"}</td>
            </tr>
          </table>
        </div>
        <div class="col-md-6">
          <div class="execution-section-title"><i class="fas fa-wallet"></i>계좌 정보</div>
          <table class="table table-sm">
            <tr>
              <td><strong>총 예수금:</strong></td>
              <td>${formatNumber(execution.total_deposit)}원</td>
            </tr>
            <tr>
              <td><strong>주문가능금액:</strong></td>
              <td>${formatNumber(execution.available_amount)}원</td>
            </tr>
            <tr>
              <td><strong>보유 종목 수:</strong></td>
              <td>${execution.holdings_count || 0}개</td>
            </tr>
          </table>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="execution-section-title"><i class="fas fa-arrow-up"></i>매수 결과</div>
          <table class="table table-sm">
            <tr>
              <td><strong>총 시도:</strong></td>
              <td>${execution.buy_count || 0}건</td>
            </tr>
            <tr>
              <td><strong>성공:</strong></td>
              <td><span class="text-success">${execution.buy_success_count || 0}건</span></td>
            </tr>
            <tr>
              <td><strong>실패:</strong></td>
              <td><span class="text-danger">${execution.buy_failed_count || 0}건</span></td>
            </tr>
            <tr>
              <td><strong>총 매수금액:</strong></td>
              <td>${formatNumber(execution.total_buy_amount)}원</td>
            </tr>
          </table>
        </div>
        <div class="col-md-6">
          <div class="execution-section-title"><i class="fas fa-arrow-down"></i>매도 결과</div>
          <table class="table table-sm">
            <tr>
              <td><strong>총 시도:</strong></td>
              <td>${execution.sell_count || 0}건</td>
            </tr>
            <tr>
              <td><strong>성공:</strong></td>
              <td><span class="text-success">${execution.sell_success_count || 0}건</span></td>
            </tr>
            <tr>
              <td><strong>실패:</strong></td>
              <td><span class="text-danger">${execution.sell_failed_count || 0}건</span></td>
            </tr>
            <tr>
              <td><strong>총 매도금액:</strong></td>
              <td>${formatNumber(execution.total_sell_amount)}원</td>
            </tr>
          </table>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-12">
          <div class="execution-section-title"><i class="fas fa-list"></i>상세 내역</div>
          <div id="execution-extra-details"></div>
          <div class="alert alert-info mt-2">
            <i class="fas fa-info-circle me-2"></i>
            (참고) 상세한 매수/매도 내역 전체는 로그 파일에서도 확인할 수 있습니다.
          </div>
        </div>
      </div>
    `;
  }

  // 분석 결과 확인
  document
    .getElementById("test-analysis-btn")
    .addEventListener("click", function () {
      const button = this;
      const originalText = button.innerHTML;

      button.disabled = true;
      button.innerHTML =
        '<i class="fas fa-spinner fa-spin me-1"></i>인증 확인 중...';

      // 먼저 인증 상태 확인
      fetch("/api/auth/status")
        .then((response) => response.json())
        .then((authData) => {
          if (!authData.success) {
            showAlert(`인증 상태 확인 실패: ${authData.message || '알 수 없는 오류'}`, "danger");
            button.disabled = false;
            button.innerHTML = originalText;
            return;
          }

          if (!authData.authenticated) {
            showAlert("키움 API 인증이 필요합니다. 먼저 인증을 완료해주세요.", "warning");
            button.disabled = false;
            button.innerHTML = originalText;
            return;
          }

          // 인증이 완료된 경우 분석 시작
          button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>분석 중...';

          // 분석 결과 조회
          return fetch("/api/auto-trading/analysis", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              force_realtime: true,
            }),
          });
        })
        .catch((error) => {
          console.error("인증 상태 확인 실패:", error);
          showAlert("인증 상태 확인 중 오류가 발생했습니다.", "danger");
          button.disabled = false;
          button.innerHTML = originalText;
        })
        .then((response) => {
          if (!response) return; // 인증 실패 시 중단
          return response.json();
        })
        .then((data) => {
          if (!data) return; // 인증 실패 시 중단
          if (data.success) {
            // 분석 결과를 모달에 표시
            displayAnalysisResult(data);
            const modal = new bootstrap.Modal(
              document.getElementById("analysisResultModal")
            );
            modal.show();
          } else {
            // 상세한 오류 정보 표시
            let errorMessage = data.message || "분석 실행에 실패했습니다.";
            if (data.error_details) {
              errorMessage += `\n오류 타입: ${data.error_details.error_type}`;
              errorMessage += `\n시간: ${data.error_details.timestamp}`;
            }
            console.error("분석 실행 실패:", data);

            // 오류 타입에 따른 다른 메시지 표시
            if (data.error_details && data.error_details.error_type === 'auth_required') {
              showAlert("키움 API 인증이 필요합니다. 먼저 인증을 완료해주세요.", "warning");
            } else {
              showAlert(errorMessage, "danger");
            }
          }
        })
        .catch((error) => {
          console.error("분석 결과 조회 실패:", error);
          showAlert(`분석 결과 조회 중 오류가 발생했습니다: ${error.message}`, "danger");
        })
        .finally(() => {
          button.disabled = false;
          button.innerHTML = originalText;
        });
    });

  // ---------------------------
  // 분석 서버(kiwoomDeepLearning) 설정/테스트
  // ---------------------------
  function setDeepLearningBadge(status, text) {
    const badge = document.getElementById("deeplearning-status-badge");
    badge.classList.remove("bg-secondary", "bg-success", "bg-danger", "bg-warning");
    badge.classList.add(status);
    badge.textContent = text;
  }

  function loadDeepLearningConfigIntoModal() {
    return fetch("/api/deeplearning/config")
      .then((r) => r.json())
      .then((data) => {
        if (!data.success) throw new Error(data.message || "설정 조회 실패");
        document.getElementById("deeplearning-host").value = data.data.host || "127.0.0.1";
        document.getElementById("deeplearning-port").value = data.data.port || 5000;
      });
  }

  function testDeepLearningHealth() {
    const pre = document.getElementById("deeplearning-test-result");
    pre.textContent = "연결 테스트 중...";
    return fetch("/api/deeplearning/health")
      .then((r) => r.json())
      .then((data) => {
        if (data.success) {
          setDeepLearningBadge("bg-success", "연결됨");
          pre.textContent = JSON.stringify(data.data, null, 2);
        } else {
          setDeepLearningBadge("bg-danger", "실패");
          pre.textContent = data.message || "연결 실패";
        }
      })
      .catch((e) => {
        setDeepLearningBadge("bg-danger", "실패");
        pre.textContent = e.message;
      });
  }

  document.getElementById("deeplearning-config-btn").addEventListener("click", function () {
    const modalEl = document.getElementById("deeplearningConfigModal");
    const modal = new bootstrap.Modal(modalEl);
    loadDeepLearningConfigIntoModal()
      .then(() => {
        document.getElementById("deeplearning-test-result").textContent = "-";
        modal.show();
      })
      .catch((e) => {
        showAlert(`분석 서버 설정을 불러오지 못했습니다: ${e.message}`, "danger");
      });
  });

  document.getElementById("deeplearning-save-btn").addEventListener("click", function () {
    const host = document.getElementById("deeplearning-host").value.trim() || "127.0.0.1";
    const port = parseInt(document.getElementById("deeplearning-port").value, 10) || 5000;

    fetch("/api/deeplearning/config", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ host, port, scheme: "http" }),
    })
      .then((r) => r.json())
      .then((data) => {
        if (!data.success) throw new Error(data.message || "저장 실패");
        showAlert("분석 서버 설정이 저장되었습니다.", "success");
        setDeepLearningBadge("bg-warning", "미확인");
      })
      .catch((e) => showAlert(`저장 실패: ${e.message}`, "danger"));
  });

  document.getElementById("deeplearning-test-btn").addEventListener("click", function () {
    testDeepLearningHealth();
  });

  // 페이지 진입 시 상태 뱃지 초기화(설정은 읽되, 연결은 사용자가 필요 시 테스트)
  fetch("/api/deeplearning/config")
    .then((r) => r.json())
    .then((data) => {
      if (data.success) setDeepLearningBadge("bg-warning", "미확인");
    })
    .catch(() => setDeepLearningBadge("bg-secondary", "미확인"));

  // 분석 결과 표시
  function displayAnalysisResult(data) {
    // 분석 결과를 전역 변수에 저장 (매매 실행 시 사용)
    window.currentAnalysisResult = data;
    
    // 디버깅: analysis_result 객체 확인
    console.log("분석 결과 저장:", data);
    console.log("analysis_result 객체:", data.analysis_result);
    
    // 분석 정보 업데이트
    document.getElementById("analysis-date").textContent =
      data.analysis_date || "-";
    document.getElementById("total-stocks").textContent =
      data.total_stocks || 0;
    document.getElementById("buy-candidates-count").textContent =
      data.buy_candidates ? data.buy_candidates.length : 0;

    // 전략 파라미터 업데이트
    const strategy = data.strategy_params || {};
    document.getElementById("strategy-top-n").textContent =
      strategy.top_n || "-";
    document.getElementById("strategy-universe").textContent =
      strategy.buy_universe_rank || "-";
    document.getElementById("strategy-fee-rate").textContent =
      strategy.transaction_fee_rate ? `${strategy.transaction_fee_rate}%` : "-";
    document.getElementById("strategy-reserve").textContent =
      strategy.reserve_cash
        ? (strategy.reserve_cash / 10000).toFixed(0) + "만원"
        : "-";

    // 💰 사용가능금액 업데이트
    const cashInfo = data.cash_info || {};
    const availableCash = cashInfo.available_cash || 0;
    document.getElementById("available-cash").textContent =
      availableCash > 0
        ? (availableCash / 10000).toFixed(0) + "만원"
        : "0원";

    // 상위 종목 리스트 업데이트
    const topStocksTbody = document.getElementById("top-stocks-tbody");
    topStocksTbody.innerHTML = "";

    // 분석 원본데이터 기준: 시가총액은 '억' 단위 → 소숫점 제거 후 '억' 표기
    const formatMarketCapEok = (val) => {
      const n = Number(val);
      if (!Number.isFinite(n)) return "-";
      return Math.floor(n).toLocaleString() + "억";
    };

    if (data.top_stocks && data.top_stocks.length > 0) {
      data.top_stocks.forEach((stock, idx) => {
        const rank = stock.최종순위 ?? (idx + 1);
        const rfProba = (stock.rf_pred_proba != null ? stock.rf_pred_proba : stock.ml_pred_proba);
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>${rank ?? "-"}</td>
                <td>${stock.종목명 || "-"}</td>
                <td>${stock.종목코드 || "-"}</td>
                <td>${
                  stock.현재가 ? stock.현재가.toLocaleString() + "원" : "-"
                }</td>
                <td>${
                  stock.시가총액 != null ? formatMarketCapEok(stock.시가총액) : "-"
                }</td>
                <td>${
                  stock.final_score ? stock.final_score.toFixed(2) : "-"
                }</td>
                <td>${
                  rfProba != null ? (Number(rfProba) * 100).toFixed(1) + "%" : "-"
                }</td>
                <td>${
                  stock.lgbm_pred_proba != null ? (Number(stock.lgbm_pred_proba) * 100).toFixed(1) + "%" : "-"
                }</td>
            `;
        topStocksTbody.appendChild(row);
      });
    } else {
      topStocksTbody.innerHTML =
        '<tr><td colspan="8" class="text-center text-muted">상위 종목이 없습니다.</td></tr>';
    }

    // 매도 대상 종목 업데이트
    const sellCandidatesTbody = document.getElementById("sell-candidates-tbody");
    sellCandidatesTbody.innerHTML = "";

    if (data.sell_candidates && data.sell_candidates.length > 0) {
      data.sell_candidates.forEach((stock) => {
        const row = document.createElement("tr");
        const profitRate = stock.수익률 || 0;
        const profitClass = profitRate > 0 ? "text-up" : profitRate < 0 ? "text-down" : "text-neutral";
        
        // 매도사유에 따른 배지 색상 결정
        let badgeClass = "bg-danger"; // 기본값: 빨간색 (익절)
        const sellReason = stock.매도사유 || "";
        if (sellReason.includes("손절")) {
            badgeClass = "bg-primary"; // 파란색 (손절)
        } else if (sellReason.includes("보유기간")) {
            badgeClass = "bg-hotpink"; // 핫핑크 (보유기간 초과)
        }
        
        row.innerHTML = `
                <td>${stock.종목명 || "-"}</td>
                <td>${stock.종목코드 || "-"}</td>
                <td>${stock.보유수량 ? stock.보유수량.toLocaleString() + "주" : "-"}</td>
                <td>${stock.평균단가 ? stock.평균단가.toLocaleString() + "원" : "-"}</td>
                <td>${stock.현재가 ? stock.현재가.toLocaleString() + "원" : "-"}</td>
                <td class="${profitClass}">${profitRate.toFixed(2)}%</td>
                <td class="text-center">
                    ${(stock.보유기간 === -1 || stock.보유기간 === '-1' || stock.보유기간 === null || stock.보유기간 === undefined)
                        ? '<span class="badge bg-secondary text-white">알 수 없음</span>'
                        : `<span class="badge bg-primary text-white">${stock.보유기간 || 0}일</span>`
                    }
                </td>
                <td>${stock.매도예상금액 ? stock.매도예상금액.toLocaleString() + "원" : "-"}</td>
                <td><span class="badge ${badgeClass} text-white">${stock.매도사유 || "-"}</span></td>
            `;
        sellCandidatesTbody.appendChild(row);
      });
    } else {
      sellCandidatesTbody.innerHTML =
        '<tr><td colspan="9" class="text-center text-muted">매도 대상이 없습니다.</td></tr>';
    }

    // 매수 대상 종목 업데이트
    const buyCandidatesTbody = document.getElementById("buy-candidates-tbody");
    buyCandidatesTbody.innerHTML = "";

    if (data.buy_candidates && data.buy_candidates.length > 0) {
      data.buy_candidates.forEach((stock, idx) => {
        const rank = stock.최종순위 ?? (idx + 1);
        const rfProba = (stock.rf_pred_proba != null ? stock.rf_pred_proba : stock.ml_pred_proba);
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>${rank ?? "-"}</td>
                <td>${stock.종목명 || "-"}</td>
                <td>${stock.종목코드 || "-"}</td>
                <td>${
                  stock.현재가 ? stock.현재가.toLocaleString() + "원" : "-"
                }</td>
                <td>${
                  stock.시가총액 != null ? formatMarketCapEok(stock.시가총액) : "-"
                }</td>
                <td>${
                  stock.final_score ? stock.final_score.toFixed(2) : "-"
                }</td>
                <td>${
                  rfProba != null ? (Number(rfProba) * 100).toFixed(1) + "%" : "-"
                }</td>
                <td>${
                  stock.lgbm_pred_proba != null ? (Number(stock.lgbm_pred_proba) * 100).toFixed(1) + "%" : "-"
                }</td>
            `;
        buyCandidatesTbody.appendChild(row);
      });
    } else {
      buyCandidatesTbody.innerHTML =
        '<tr><td colspan="8" class="text-center text-muted">매수 대상이 없습니다.</td></tr>';
    }

  }

  // 매수 대상으로 매매 실행
  document
    .getElementById("execute-with-candidates")
    .addEventListener("click", function () {
      if (
        !window.currentAnalysisResult ||
        !window.currentAnalysisResult.analysis_result
      ) {
        console.error("분석 결과 없음:", window.currentAnalysisResult);
        showAlert("분석 결과가 없습니다.", "warning");
        return;
      }

      const button = this;
      const originalText = button.innerHTML;

      button.disabled = true;
      button.innerHTML =
        '<i class="fas fa-spinner fa-spin me-1"></i>실행 중...';

      fetch("/api/auto-trading/execute-with-candidates", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          analysis_result: window.currentAnalysisResult.analysis_result,
          manual_execution: true,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("자동매매가 성공적으로 실행되었습니다.", "success");
            updateAutoTradingStatus();
            loadExecutionHistory();
            startProgressMonitoring();

            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("analysisResultModal")
            );
            modal.hide();
          } else {
            showAlert(
              data.message || "자동매매 실행에 실패했습니다.",
              "danger"
            );
          }
        })
        .catch((error) => {
          console.error("매매 실행 실패:", error);
          showAlert("자동매매 실행 중 오류가 발생했습니다.", "danger");
        })
        .finally(() => {
          button.disabled = false;
          button.innerHTML = originalText;
        });
    });

  // 수동 실행
  document
    .getElementById("manual-execute-btn")
    .addEventListener("click", function () {
      const modal = new bootstrap.Modal(
        document.getElementById("manualExecuteModal")
      );
      modal.show();
    });

  document
    .getElementById("confirm-manual-execute")
    .addEventListener("click", function () {
      fetch("/api/auto-trading/execute", {
        method: "POST",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("자동매매가 실행되었습니다.", "success");
            loadExecutionHistory();
            updateAutoTradingStatus();
          } else {
            showAlert(
              data.message || "자동매매 실행에 실패했습니다.",
              "danger"
            );
          }
        })
        .catch((error) => {
          console.error("수동 실행 실패:", error);
          showAlert("자동매매 실행 중 오류가 발생했습니다.", "danger");
        });

      const modal = bootstrap.Modal.getInstance(
        document.getElementById("manualExecuteModal")
      );
      modal.hide();

      // 실행 시작 후 진행 상황 모니터링 시작
      startProgressMonitoring();
    });

  // 긴급 중지
  document
    .getElementById("emergency-stop-btn")
    .addEventListener("click", function () {
      const modal = new bootstrap.Modal(
        document.getElementById("emergencyStopModal")
      );
      modal.show();
    });

  document
    .getElementById("confirm-emergency-stop")
    .addEventListener("click", function () {
      fetch("/api/auto-trading/stop", {
        method: "POST",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("자동매매가 중지되었습니다.", "warning");
            updateAutoTradingStatus();
          } else {
            showAlert(
              data.message || "자동매매 중지에 실패했습니다.",
              "danger"
            );
          }
        })
        .catch((error) => {
          console.error("긴급 중지 실패:", error);
          showAlert("자동매매 중지 중 오류가 발생했습니다.", "danger");
        });

      const modal = bootstrap.Modal.getInstance(
        document.getElementById("emergencyStopModal")
      );
      modal.hide();
    });
</script>

<style>
/* 핫핑크 배지 색상 */
.bg-hotpink {
    background-color: #ff69b4 !important;
}
</style>
{% endblock %}
